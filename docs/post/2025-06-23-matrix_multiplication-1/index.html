<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <title>Matrix multiplication operation (I) - using OpenMP to speed up loop calculation :: Andrew Moa Blog Site - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Speaking of matrices, anyone who studies science and engineering will think of the fear of being dominated by linear algebra classes. Matrix multiplication operations are indispensable for various industrial and scientific research numerical calculations, and are also used in various benchmarking software. The time consumption of matrix multiplication operations is also an important indicator for judging the floating-point operation performance of computers. The purpose of this article is to verify the performance differences of various implementation methods through matrix multiplication operations, and compare the performance differences of different computing platforms to provide a reference for high-performance computing development.
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="https://andrewmoa.site/post/2025-06-23-matrix_multiplication-1/">
  <meta property="og:site_name" content="Andrew Moa Blog Site">
  <meta property="og:title" content="Matrix multiplication operation (I) - using OpenMP to speed up loop calculation">
  <meta property="og:description" content="Speaking of matrices, anyone who studies science and engineering will think of the fear of being dominated by linear algebra classes. Matrix multiplication operations are indispensable for various industrial and scientific research numerical calculations, and are also used in various benchmarking software. The time consumption of matrix multiplication operations is also an important indicator for judging the floating-point operation performance of computers. The purpose of this article is to verify the performance differences of various implementation methods through matrix multiplication operations, and compare the performance differences of different computing platforms to provide a reference for high-performance computing development.">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-06-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-23T00:00:00+00:00">
    <meta property="article:tag" content="C&#43;&#43;">
    <meta property="article:tag" content="Fortran">
    <meta property="article:tag" content="Rust">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Matrix multiplication operation (I) - using OpenMP to speed up loop calculation">
  <meta name="twitter:description" content="Speaking of matrices, anyone who studies science and engineering will think of the fear of being dominated by linear algebra classes. Matrix multiplication operations are indispensable for various industrial and scientific research numerical calculations, and are also used in various benchmarking software. The time consumption of matrix multiplication operations is also an important indicator for judging the floating-point operation performance of computers. The purpose of this article is to verify the performance differences of various implementation methods through matrix multiplication operations, and compare the performance differences of different computing platforms to provide a reference for high-performance computing development.">


<link rel="canonical" href="https://andrewmoa.site/post/2025-06-23-matrix_multiplication-1/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.min.8f52268ce38691bd84eeee05121a11e2bc53c0e9f7fa97e2b147af29c8a627e1.css">





      <script async src="https://www.googletagmanager.com/gtag/js?id=G-75W5D7R0V1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-75W5D7R0V1');
        }
      </script>




  
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Andrew Moa"},"dateModified":"2025-06-23T00:00:00Z","datePublished":"2025-06-23T00:00:00Z","description":"Speaking of matrices, anyone who studies science and engineering will think of the fear of being dominated by linear algebra classes. Matrix multiplication operations are indispensable for various industrial and scientific research numerical calculations, and are also used in various benchmarking software. The time consumption of matrix multiplication operations is also an important indicator for judging the floating-point operation performance of computers. The purpose of this article is to verify the performance differences of various implementation methods through matrix multiplication operations, and compare the performance differences of different computing platforms to provide a reference for high-performance computing development.\n","image":"/images/code-bg.jpg","name":"Matrix multiplication operation (I) - using OpenMP to speed up loop calculation","url":"https://andrewmoa.site/post/2025-06-23-matrix_multiplication-1/"}
</script>

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/logo.svg" alt="logo">
    </a>
  </div>
  
  <h1 class="hidden md:flex flex-col justify-center mx-2">
    <a href="/" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">
      Andrew Moa Blog Site
    </a>
  </h1>
  
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">Open main menu</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-xs md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600"
            href="/post/" title="Post">Post</a>
        </li>
      
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/about/" title="About">About</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none">
    <div class="h-full static">
      <button id="navbar-lang-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
        <span class="sr-only">Open language switcher</span>
        <i class="w-8 h-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c0 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>

        </i>
      </button>
      <div class="absolute hidden top-16 z-50" id="navbar-lang">
        <ul class="flex flex-col rounded-xs px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
          <li class="">
            <span class="block px-3 py-3 cursor-default hover:text-emerald-600">English</span>
            </li>
        
          <li class="">
            <a class="block px-3 py-3 hover:text-emerald-600"
              href="/zh-cn/post/2025-06-23-matrix_multiplication-1/" title="中文">中文</a></li>
        
        </ul>
      </div>
    </div>
  </div>
  
  <div class="flex-none md:hidden">
    <a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="relative flex items-center gap-1 px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="absolute z-10 w-15 h-8 rounded-full bg-white dark:bg-gray-700"></div>
      <i class="h-6 w-6 z-20 ml-1 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:invisible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

      </i>
      <i class="h-6 w-6 z-20 mr-1 flex-none rounded-full place-self-center invisible peer-checked:visible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

      </i>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div id="progress" class="fixed top-0 left-0 w-full h-1 bg-blue-500"></div>
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/post/2025-06-23-matrix_multiplication-1/">
        <figure>
    <img class="w-full object-cover h-36 md:h-48 xl:h-60" src="/images/code-bg.jpg"
      alt="Matrix multiplication operation (I) - using OpenMP to speed up loop calculation" title="Matrix multiplication operation (I) - using OpenMP to speed up loop calculation"
      loading="lazy"
    >
  </figure>
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/post/2025-06-23-matrix_multiplication-1/">Matrix multiplication operation (I) - using OpenMP to speed up loop calculation</a>
      </h1>

      
      
  <ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300">
    
      
      <li>
        <a href="/categories/code/"
          class="text-sm mr-2 px-2 py-1 rounded-sm border border-emerald-800 bg-emerald-800 text-slate-50">
          Code
        </a>
      </li>
      
    
    
      
      <li>
        <a href="/tags/c&#43;&#43;/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">C&#43;&#43;</span>
        </a>
      </li>
      
      <li>
        <a href="/tags/fortran/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">Fortran</span>
        </a>
      </li>
      
      <li>
        <a href="/tags/rust/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">Rust</span>
        </a>
      </li>
      
    
  </ul>



      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  
  
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
   <path d="M16 3v4"></path>
   <path d="M8 3v4"></path>
   <path d="M4 11h16"></path>
   <path d="M11 15h1"></path>
   <path d="M12 15v3"></path>
</svg>

    </i>
    <time datetime="2025-06-23T00:00:00&#43;00:00">
      2025-06-23
    </time>
  </div>

  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      42 minutes to read
    </span>
  </div>
</div>

      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>

    </i>
    <span>Andrew Moa</span>
  </div>
</div>

      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>Table of Contents</h2>
          <aside><nav id="TableOfContents">
  <ul>
    <li><a href="#1-matrix-multiplication-algorithm">1. Matrix multiplication algorithm</a></li>
    <li><a href="#2-parallelization-of-nested-loops">2. Parallelization of nested loops</a>
      <ul>
        <li><a href="#21-c-implementation">2.1 C Implementation</a></li>
        <li><a href="#22-fortran-implementation">2.2 Fortran Implementation</a></li>
        <li><a href="#23-rust-implementation">2.3 Rust implementation</a></li>
      </ul>
    </li>
    <li><a href="#3-3-matrix-block-parallelization">3. 3. Matrix Block Parallelization</a>
      <ul>
        <li><a href="#31-matrix-block-c-implementation">3.1 Matrix block C implementation</a></li>
        <li><a href="#32-matrix-block-fortran-implementation">3.2 Matrix block fortran implementation</a></li>
        <li><a href="#33-matrix-block-rust-implementation">3.3 Matrix block rust implementation</a></li>
      </ul>
    </li>
    <li><a href="#4-the-black-magic-of-compilers">4. The Black Magic of Compilers</a>
      <ul>
        <li><a href="#41-fortran-built-in-function-matmul">4.1 Fortran built-in function matmul</a></li>
        <li><a href="#42-rust-implemented-through-the-ndarray-library">4.2 Rust implemented through the ndarray library</a></li>
        <li><a href="#43-rust-implemented-through-the-mathru-library">4.3 Rust implemented through the mathru library</a></li>
      </ul>
    </li>
    <li><a href="#5-summarize">5. Summarize</a></li>
  </ul>
</nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <p>Speaking of matrices, anyone who studies science and engineering will think of the fear of being dominated by linear algebra classes. Matrix multiplication operations are indispensable for various industrial and scientific research numerical calculations, and are also used in various benchmarking software. The time consumption of matrix multiplication operations is also an important indicator for judging the floating-point operation performance of computers. The purpose of this article is to verify the performance differences of various implementation methods through matrix multiplication operations, and compare the performance differences of different computing platforms to provide a reference for high-performance computing development.</p>
<h2 id="1-matrix-multiplication-algorithm">1. Matrix multiplication algorithm</h2>
<p>Matrix multiplication is also called matrix dot multiplication, which can be represented by the following figure <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. It is usually formed by multiplying and accumulating the elements of the corresponding rows of matrix A and the corresponding columns of matrix B to form the values of the corresponding rows and columns of matrix C. The number of columns of matrix A must be equal to the number of rows of matrix B, and the size of matrix C is equal to the number of rows of matrix B × the number of columns of matrix A.<div class="not-prose">
<picture>
    <source type="image/webp" srcset="/post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_ca1ba86b3d0ff44b.webp 320w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_152641224c20d9c8.webp 640w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_fdb29b53f62cf657.webp 960w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_fc47eb19c1e6b84f.webp 1280w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_9d0e40a2784dbb10.webp 1600w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_d069d32946e84337.webp 1920w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <source type="image/jpeg" srcset="/post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_459c32de344b1547.jpg 320w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_7c7416563f69bcd8.jpg 640w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_6bce63bd57b3d50b.jpg 960w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_18731d945c01b319.jpg 1280w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_b8cee494789e09f2.jpg 1600w, /post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_d032c6b5a4fd99cd.jpg 1920w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <img class="h-auto max-w-full rounded-lg" src="/post/2025-06-23-matrix_multiplication-1/images/06d7ac8e02b5dab1769e5284772bdf9e_hu_7c7416563f69bcd8.jpg" width="1920" height="1920" alt="06d7ac8e02b5dab1769e5284772bdf9e.png" title="06d7ac8e02b5dab1769e5284772bdf9e.png" loading="lazy" />
  </picture>
</div>
</p>
<p>Using C language to represent an M×N matrix dot multiplication with an N×T matrix, it is generally written in the form of 3 layers of nested loops.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">M</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><p>It is generally believed that the number of multiplications of an N×N dimensional matrix is ​​N to the power of 3, and the computational complexity is expressed as O(n<sup>3</sup>). There are also some algorithms that convert some of the multiplication operations into additions, reducing the number of multiplication operations. For example, the Strassen algorithm<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> has a theoretical computational complexity of only O(n<sup>2.807</sup>), which reduces the time spent on multiplying large matrices. Newer algorithms such as the Coppersmith-Winograd method are said to have a computational complexity of only O(n<sup>2.3727</sup>). This difference in algorithms is not discussed in this article.</p>
<h2 id="2-parallelization-of-nested-loops">2. Parallelization of nested loops</h2>
<p>Modern computer processors are generally multi-core. To fully utilize the processor performance, it is a good option to use parallel libraries such as OpenMP to parallelize the calculation program. It is meaningless to use a single core to solve the nested loop. I will not demonstrate it here. If you are interested, you can remove the parallel library from the following code and compile and calculate it.</p>
<h3 id="21-c-implementation">2.1 C Implementation</h3>
<p>The C implementation is very simple, using three layers of nested loops to implement the matrix multiplication algorithm. Here, openmp is used to merge the first two layers of loops and assign them to different threads for calculation <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>, so as to fully utilize the performance of multi-core processors. The following is the sample code of <code>openmp.c</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#pragma omp parallel for collapse(2) shared(A, B, C)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#pragma omp parallel for collapse(2) shared(A, B, C)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In <code>main.c</code>, some command line switches are defined, and users can customize matrix size, number of loops, calculation accuracy, etc. A performance parameter, GFLOPs, is defined here to measure the ability to perform floating-point operations per unit time. 1 GFLOPs is equivalent to performing 10<sup>9</sup> floating-point operations in 1 second.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX(a, b) ((a) &gt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MIN(a, b) ((a) &lt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Initialize matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Execute matrix multiply and print results
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">execute_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">volatile</span> <span class="kt">float</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span> 
</span></span><span class="line"><span class="cl">		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">execute_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">volatile</span> <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span> 
</span></span><span class="line"><span class="cl">		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>								   <span class="c1">// Default matrix size exponent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">loop_num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>						   <span class="c1">// Number of iterations for averaging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">double</span> <span class="n">ave_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">max_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// Average and maximum Gflops
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">double</span> <span class="n">ave_time</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">;</span>	   <span class="c1">// Average and minimum time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">use_double</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>						   <span class="c1">// Default to float precision
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Help message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-h&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--help&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s [-n SIZE] [-l LOOP_NUM] [-float|-double]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -n SIZE      Specify matrix size, like 2^SIZE (default: 10)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -l LOOP_NUM  Specify number of iterations (default: 5)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -float       Use float precision (default)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -double      Use double precision</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -h, --help   Show this help message</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Parse -n, -l, -float, -double options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">double_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">float_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">argi</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">argi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-n&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">n</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-l&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">loop_num</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-double&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">double_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-float&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">float_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">double_flag</span> <span class="o">&amp;&amp;</span> <span class="n">float_flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error: Cannot specify both -double and -float options.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">use_double</span> <span class="o">=</span> <span class="n">double_flag</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">use_double</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using double precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">execute_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using float precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">execute_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Gflops: %.3f, Max Gflops: %.3f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_gflops</span><span class="p">,</span> <span class="n">max_gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Time: %.6fs, Min Time: %.6fs</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_time</span><span class="p">,</span> <span class="n">min_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>CMake is used here, and <code>CMakeLists.txt</code> tells the compiler how to include the openmp header file and link to it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">openmp</span> <span class="s">LANGUAGES</span> <span class="s">C</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenMP</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/openmp.c</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenMP::OpenMP_C</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>The Release program compiled by clang-cl of vs2022 on Windows platform has the following execution effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">\</span><span class="n">Release</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/Release/openmp_msvc_clang_19.1.5.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">362688s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">921Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">304758s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">047Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314348s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">832Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">294248s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">298Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">294496s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">292Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">306986s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">995Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">320405s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">702Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">278521s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">710Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">294080s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">302Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">338626s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">342Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.944</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">7.710</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">310916s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">278521s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">\</span><span class="n">Release</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/Release/openmp_msvc_clang_19.1.5.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">353909s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">068Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">319001s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">732Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">329514s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">517Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">381114s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">635Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">349447s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">145Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">370087s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">803Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">349626s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">142Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">370023s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">804Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">364005s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">900Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">344441s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">235Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.098</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.732</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">353117s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">319001s</span>
</span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s clang64 toolchain, the Release program execution results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_clang_20.1.7.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">344437s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">235Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">327010s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">567Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">367141s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">849Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">358603s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">988Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">362182s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">929Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">338947s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">336Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">334758s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">415Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">331219s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">484Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">343316s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">255Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">324451s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">619Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.268</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.619</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">343206s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">324451s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_clang_20.1.7.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">447118s</span><span class="p">(</span><span class="mf">4</span><span class="p">.</span><span class="n">803Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">423630s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">069Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">365229s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">880Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">355163s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">046Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">443296s</span><span class="p">(</span><span class="mf">4</span><span class="p">.</span><span class="n">844Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">310319s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">920Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">366405s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">861Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">369704s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">809Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">382898s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">608Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">367266s</span><span class="p">(</span><span class="mf">5</span><span class="p">.</span><span class="n">847Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">5.669</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.920</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">383103s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">310319s</span>
</span></span></code></pre></div><p>Switch to MSYS2&rsquo;s ucrt64 toolchain to compile, and the Release program execution effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>        
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">308967s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">951Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">267709s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">022Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">278587s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">708Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">263047s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">164Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">262595s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">178Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">264196s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">128Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">273148s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">862Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">262910s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">168Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">277290s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">745Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">274961s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">810Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">7.874</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">8.178</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">273341s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">262595s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314685s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">824Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">290665s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">388Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">304162s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">060Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">315041s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">817Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">306290s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">011Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">356495s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">024Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">310081s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">926Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">301022s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">134Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">317229s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">769Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">307106s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">993Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.895</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">7.388</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">312278s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">290665s</span>
</span></span></code></pre></div><p>The performance of the gcc compiler on the Windows platform is slightly better. The computing performance of the three is basically at the same level, and the difference is small and can be ignored.</p>
<p>The above are all calculated results on the AMD AI 9 365w processor, and all cores and hyperthreads are basically fully utilized during the calculation process. The calculation results shown in this article, unless otherwise specified, are the results output by running on this processor.</p>
<h3 id="22-fortran-implementation">2.2 Fortran Implementation</h3>
<p>Fortran has a built-in matrix operation function matmul. We will not consider the algorithm optimization of built-in functions here. The three-layer loop nesting implemented in C is implemented in Fortran, and then accelerated by openmp.</p>
<p>The function implemented by <code>main.f90</code> is the same as that of <code>main.c</code> implemented in C.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">program</span><span class="w"> </span><span class="n">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">external</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">         
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">loop_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ave_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e9</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">use_double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">double_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="n">float_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">command_argument_count</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="n">print_help</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">stop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">argi</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">command_argument_count</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="nb">get_command_argument</span><span class="p">(</span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-n&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">command_argument_count</span><span class="p">())</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">get_command_argument</span><span class="p">(</span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">read</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-l&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">command_argument_count</span><span class="p">())</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">get_command_argument</span><span class="p">(</span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">read</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-double&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">double_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">use_double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-float&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">float_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">use_double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-h&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;--help&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">print_help</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">stop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">double_set</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">float_set</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;Error: Cannot specify both -double and -float options.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">stop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_double</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="n">perform_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">,</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="n">perform_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">,</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="s1">&#39;(A, F8.3, A, F8.3)&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Average Gflops: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;, Max Gflops: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="s1">&#39;(A, F10.6, A, F10.6, A)&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Average Time: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;s, Min Time: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">contains</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">subroutine</span><span class="w"> </span><span class="n">print_help</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Usage: program_name [-n SIZE] [-l LOOP_NUM] [-float|-double]&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;  -n SIZE      Specify matrix size, like 2^SIZE (default: 10)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;  -l LOOP_NUM  Specify number of iterations (default: 5)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;  -float       Use real*32 precision (default)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;  -double      Use real*64 precision&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;  -h, --help   Show this help message&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">print_help</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">subroutine</span><span class="w"> </span><span class="n">initialize_matrix_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">matrix</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">rand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="nb">random_seed</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">call</span><span class="w"> </span><span class="nb">random_number</span><span class="p">(</span><span class="nb">rand</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">initialize_matrix_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">subroutine</span><span class="w"> </span><span class="n">initialize_matrix_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">matrix</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">rand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">call</span><span class="w"> </span><span class="nb">random_seed</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">call</span><span class="w"> </span><span class="nb">random_number</span><span class="p">(</span><span class="nb">rand</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">initialize_matrix_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">subroutine</span><span class="w"> </span><span class="n">perform_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">,</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">min_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a_double</span><span class="p">(:,</span><span class="w"> </span><span class="p">:),</span><span class="w"> </span><span class="n">b_double</span><span class="p">(:,</span><span class="w"> </span><span class="p">:),</span><span class="w"> </span><span class="k">c_double</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Using real*64 precision for matrix multiplication.&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">a_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">),</span><span class="w"> </span><span class="n">b_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">),</span><span class="w"> </span><span class="k">c_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">))</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">initialize_matrix_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">a_double</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">initialize_matrix_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">b_double</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span><span class="o">=</span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">count_rate</span><span class="o">=</span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">a_double</span><span class="p">,</span><span class="w"> </span><span class="n">b_double</span><span class="p">,</span><span class="w"> </span><span class="k">c_double</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span><span class="o">=</span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">elapsed_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">real</span><span class="p">(</span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">real</span><span class="p">(</span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s1">&#39;(I8, A, I0, A, I0, A, F10.6, A, F8.3, A)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; : &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; x &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; Matrix multiply wall time : &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">elapsed_time</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;s(&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gflops</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Gflops)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">max_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">gflops</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">min_time</span><span class="p">,</span><span class="w"> </span><span class="n">elapsed_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">a_double</span><span class="p">,</span><span class="w"> </span><span class="n">b_double</span><span class="p">,</span><span class="w"> </span><span class="k">c_double</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">perform_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">subroutine</span><span class="w"> </span><span class="n">perform_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">,</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">min_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a_float</span><span class="p">(:,</span><span class="w"> </span><span class="p">:),</span><span class="w"> </span><span class="n">b_float</span><span class="p">(:,</span><span class="w"> </span><span class="p">:),</span><span class="w"> </span><span class="k">c_float</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">integer</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Using real*32 precision for matrix multiplication.&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">a_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">),</span><span class="w"> </span><span class="n">b_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">),</span><span class="w"> </span><span class="k">c_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">initialize_matrix_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">a_float</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">initialize_matrix_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">b_float</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span><span class="o">=</span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">count_rate</span><span class="o">=</span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="n">a_float</span><span class="p">,</span><span class="w"> </span><span class="n">b_float</span><span class="p">,</span><span class="w"> </span><span class="k">c_float</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">call</span><span class="w"> </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span><span class="o">=</span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">elapsed_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">real</span><span class="p">(</span><span class="n">end_count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">real</span><span class="p">(</span><span class="n">count_rate</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s1">&#39;(I8, A, I0, A, I0, A, F10.6, A, F8.3, A)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; : &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; x &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">dim</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; Matrix multiply wall time : &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">elapsed_time</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;s(&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">gflops</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Gflops)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">max_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">gflops</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ave_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">elapsed_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">min_time</span><span class="p">,</span><span class="w"> </span><span class="n">elapsed_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">a_float</span><span class="p">,</span><span class="w"> </span><span class="n">b_float</span><span class="p">,</span><span class="w"> </span><span class="k">c_float</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">perform_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">program</span><span class="w"> </span><span class="n">main</span><span class="w">
</span></span></span></code></pre></div><p><code>omp.f90</code> is a concrete implementation of the three-layer loop algorithm, and also uses OpenMP to expand the first two layers of loops to achieve parallelization.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp parallel do private(i, j, k) shared(a, b, c, n) collapse(2)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">   </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp end parallel do
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp parallel do private(i, j, k) shared(a, b, c, n) collapse(2)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">   </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp end parallel do
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>The contents of the <code>CMakeLists.txt</code> file are shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">openmp-fortran</span> <span class="s">LANGUAGES</span> <span class="s">Fortran</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_Fortran_STANDARD</span> <span class="s">2008</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable OpenMP
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenMP</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.f90</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/omp.f90</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenMP::OpenMP_Fortran</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>Compile using Intel oneAPI ifx, and the Release program execution effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">\</span><span class="n">Release</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/Release/openmp-fortran_msvc_intelllvm_2025.1.1.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">299000s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">182Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">284000s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">562Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">337000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">372Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">310000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">927Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">321000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">690Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">358000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">999Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">290000s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">405Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">312000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">883Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">301000s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">134Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">290000s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">405Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">6.956</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">7.562</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">310200s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">284000s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">\</span><span class="n">Release</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/Release/openmp-fortran_msvc_intelllvm_2025.1.1.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">391000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">492Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">362000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">932Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">334000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">430Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">393000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">464Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">331000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">488Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">357000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">015Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">366000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">867Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">345000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">225Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">341000s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">298Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">359000s</span><span class="p">(</span>   <span class="mf">5</span><span class="p">.</span><span class="n">982Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">6.019</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">6.488</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">357900s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">331000s</span>
</span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s ucrt64 toolchain, the Release program execution results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/openmp-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>        
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">224624s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">560Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">224959s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">546Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">228968s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">379Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">238853s</span><span class="p">(</span>   <span class="mf">8</span><span class="p">.</span><span class="n">991Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">216879s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">902Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">212407s</span><span class="p">(</span>  <span class="mf">10</span><span class="p">.</span><span class="n">110Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">233809s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">185Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">240426s</span><span class="p">(</span>   <span class="mf">8</span><span class="p">.</span><span class="n">932Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">241291s</span><span class="p">(</span>   <span class="mf">8</span><span class="p">.</span><span class="n">900Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">222414s</span><span class="p">(</span>   <span class="mf">9</span><span class="p">.</span><span class="n">655Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">9.416</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">10.110</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">228463s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">212407s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/openmp-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">258885s</span><span class="p">(</span>   <span class="mf">8</span><span class="p">.</span><span class="n">295Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">299699s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">165Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">298025s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">206Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">291631s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">364Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">271050s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">923Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">330989s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">488Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">278846s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">701Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">281121s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">639Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">288999s</span><span class="p">(</span>   <span class="mf">7</span><span class="p">.</span><span class="n">431Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">318669s</span><span class="p">(</span>   <span class="mf">6</span><span class="p">.</span><span class="n">739Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">7.395</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>    <span class="mf">8.295</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">291792s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">258885s</span>
</span></span></code></pre></div><p>The result of running on AMD processor shows that Intel ifx version is slower than gcc version, and this is also true for multiple attempts.</p>
<p>The generated program is copied to Intel workstation (Xeon Gold 6226R) and the running time of both versions is basically the same. It is doubtful whether Intel compiler has made some negative optimization for AMD platform.<div class="not-prose">
<picture>
    <source type="image/webp" srcset="/post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_f18a23681188fe17.webp 320w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_2749a6f5fcb0a1af.webp 640w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_8351ae552446410c.webp 960w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_ce229a2b5c094ddc.webp 1280w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_464c4e6e1ac161c7.webp 1600w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <source type="image/jpeg" srcset="/post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_7dedee86875434d4.jpg 320w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_13e3851506ec9c5d.jpg 640w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_5a1ed46fedf88bf9.jpg 960w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_7840cf660eed0980.jpg 1280w, /post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_fd4c1dbce37e1325.jpg 1600w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <img class="h-auto max-w-full rounded-lg" src="/post/2025-06-23-matrix_multiplication-1/images/450c425a5b66a15d10c33f91913d83db_hu_13e3851506ec9c5d.jpg" width="1730" height="924" alt="450c425a5b66a15d10c33f91913d83db.png" title="450c425a5b66a15d10c33f91913d83db.png" loading="lazy" />
  </picture>
</div>

<div class="not-prose">
<picture>
    <source type="image/webp" srcset="/post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_91fcd3adf9eb8b57.webp 320w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_4ccbaadd83ee0ce.webp 640w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_5932db096b22b038.webp 960w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_3a518c6517702387.webp 1280w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_967cd7a85ab21110.webp 1600w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <source type="image/jpeg" srcset="/post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_abe655edc85bc135.jpg 320w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_182859377cf35d12.jpg 640w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_9ddfa4e7016881cc.jpg 960w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_a3f3dcc2cd6c8891.jpg 1280w, /post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_4bcd7b90889c75a3.jpg 1600w" sizes="(min-width: 1024px) 100vw, 50vw" />
    <img class="h-auto max-w-full rounded-lg" src="/post/2025-06-23-matrix_multiplication-1/images/e288c089679272a2da278060b45df296_hu_182859377cf35d12.jpg" width="1730" height="924" alt="e288c089679272a2da278060b45df296.png" title="e288c089679272a2da278060b45df296.png" loading="lazy" />
  </picture>
</div>
</p>
<h3 id="23-rust-implementation">2.3 Rust implementation</h3>
<p>There is no native implementation of openmp in rust, but there is a parallel library rayon with similar functions. Here, rust+rayon is used to implement a three-layer loop nesting algorithm.</p>
<p><code>main.rs</code> implements the same function as <code>main.c</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">mod</span> <span class="nn">matmul</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">matmul</span>::<span class="p">{</span><span class="n">matrix_multiply_double</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">clap</span>::<span class="p">{</span><span class="n">Arg</span><span class="p">,</span><span class="w"> </span><span class="n">ArgAction</span><span class="p">,</span><span class="w"> </span><span class="n">Command</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Instant</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">matrix</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">rng</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">random</span>::<span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">matrix</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f64</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">rng</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">random</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">execute_float</span><span class="p">(</span><span class="n">dim</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ave_gflops</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">max_gflops</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ave_time</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="no">MAX</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">loop_num</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span>::<span class="n">now</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cpu_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">().</span><span class="n">as_secs_f64</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;</span><span class="si">{}</span><span class="se">\t</span><span class="s">: </span><span class="si">{}</span><span class="s"> x </span><span class="si">{}</span><span class="s"> Matrix multiply wall time : </span><span class="si">{:.6}</span><span class="s">s(</span><span class="si">{:.3}</span><span class="s">Gflops)&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dim</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dim</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cpu_time</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gflops</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">max_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">gflops</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ave_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cpu_time</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_time</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">cpu_time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">loop_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_time</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">loop_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">execute_double</span><span class="p">(</span><span class="n">dim</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ave_gflops</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">max_gflops</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ave_time</span>: <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="no">MAX</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">loop_num</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span>::<span class="n">now</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cpu_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">elapsed</span><span class="p">().</span><span class="n">as_secs_f64</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dim</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cpu_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;</span><span class="si">{}</span><span class="se">\t</span><span class="s">: </span><span class="si">{}</span><span class="s"> x </span><span class="si">{}</span><span class="s"> Matrix multiply wall time : </span><span class="si">{:.6}</span><span class="s">s(</span><span class="si">{:.3}</span><span class="s">Gflops)&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dim</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dim</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cpu_time</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gflops</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">max_gflops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">gflops</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ave_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cpu_time</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">min_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_time</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">cpu_time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_gflops</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">loop_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ave_time</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">loop_num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;rayon-rs&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">version</span><span class="p">(</span><span class="s">&#34;0.1.0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">author</span><span class="p">(</span><span class="s">&#34;AndrewMoa&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">about</span><span class="p">(</span><span class="s">&#34;Matrix multiplication benchmark&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Arg</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">short</span><span class="p">(</span><span class="sc">&#39;n&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">long</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">help</span><span class="p">(</span><span class="s">&#34;Matrix size exponent (size = 2^n)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">default_value</span><span class="p">(</span><span class="s">&#34;10&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Arg</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;loops&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">short</span><span class="p">(</span><span class="sc">&#39;l&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">long</span><span class="p">(</span><span class="s">&#34;loops&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">help</span><span class="p">(</span><span class="s">&#34;Number of iterations&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">default_value</span><span class="p">(</span><span class="s">&#34;5&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Arg</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;f64&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">short</span><span class="p">(</span><span class="sc">&#39;d&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">long</span><span class="p">(</span><span class="s">&#34;f64&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">help</span><span class="p">(</span><span class="s">&#34;Use float64 precision&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">action</span><span class="p">(</span><span class="n">ArgAction</span>::<span class="n">SetTrue</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Arg</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;f32&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">short</span><span class="p">(</span><span class="sc">&#39;f&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">long</span><span class="p">(</span><span class="s">&#34;f32&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">help</span><span class="p">(</span><span class="s">&#34;Use float32 precision (default)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="n">action</span><span class="p">(</span><span class="n">ArgAction</span>::<span class="n">SetTrue</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">get_matches</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">matches</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">get_one</span>::<span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">parse</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Invalid size exponent&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">loop_num</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">matches</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">get_one</span>::<span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;loops&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">parse</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Invalid loop count&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">use_double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matches</span><span class="p">.</span><span class="n">get_flag</span><span class="p">(</span><span class="s">&#34;f64&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">use_float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matches</span><span class="p">.</span><span class="n">get_flag</span><span class="p">(</span><span class="s">&#34;f32&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">use_double</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">use_float</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">&#34;Error: Cannot specify both --f64 and --f32&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">std</span>::<span class="n">process</span>::<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="k">usize</span><span class="p">.</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">use_double</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Using f64 precision for matrix multiplication.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;Average Gflops: </span><span class="si">{:.3}</span><span class="s">, Max Gflops: </span><span class="si">{:.3}</span><span class="s">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Average Time: </span><span class="si">{:.6}</span><span class="s">s, Min Time: </span><span class="si">{:.6}</span><span class="s">s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Using f32 precision for matrix multiplication.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">loop_num</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;Average Gflops: </span><span class="si">{:.3}</span><span class="s">, Max Gflops: </span><span class="si">{:.3}</span><span class="s">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ave_gflops</span><span class="p">,</span><span class="w"> </span><span class="n">max_gflops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Average Time: </span><span class="si">{:.6}</span><span class="s">s, Min Time: </span><span class="si">{:.6}</span><span class="s">s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ave_time</span><span class="p">,</span><span class="w"> </span><span class="n">min_time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The specific algorithm is implemented in the <code>matmul.rs</code> file. Here, a two-layer loop is used instead of a three-layer loop, and then the outermost loop is expanded through rayon to achieve parallelization. The actual effect is similar to openmp.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">rayon</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">par_iter_mut</span><span class="p">().</span><span class="n">enumerate</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">c_ij</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">*</span><span class="n">c_ij</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">*</span><span class="n">c_ij</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f64</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">par_iter_mut</span><span class="p">().</span><span class="n">enumerate</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">c_ij</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">*</span><span class="n">c_ij</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">*</span><span class="n">c_ij</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The configuration file <code>Cargo.toml</code> file is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;rayon-rs&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">edition</span> <span class="p">=</span> <span class="s2">&#34;2024&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">clap</span> <span class="p">=</span> <span class="p">{</span> <span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;4.5.40&#34;</span><span class="p">,</span> <span class="nx">features</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;derive&#34;</span><span class="p">]</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">rand</span> <span class="p">=</span> <span class="s2">&#34;0.9.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">rayon</span> <span class="p">=</span> <span class="s2">&#34;1.10.0&#34;</span>
</span></span></code></pre></div><p>Compiled using the msvc toolchain on the Windows platform, the Release program has the following effects:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>   
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">04s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">183645s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">694Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">189942s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">306Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">186613s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">508Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">190823s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">254Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">197830s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">855Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">194282s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">053Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">199380s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">771Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">198576s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">814Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">190201s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">291Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">195518s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">984Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">11.153</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">11.694</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">192681s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">183645s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">04s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">188721s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">379Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">186753s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">499Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">206919s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">378Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">197388s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">879Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">196899s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">907Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">206537s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">398Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">200781s</span><span class="p">(</span><span class="mf">10</span><span class="p">.</span><span class="n">696Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">191448s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">217Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">192770s</span><span class="p">(</span><span class="mf">11</span><span class="p">.</span><span class="n">140Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">178019s</span><span class="p">(</span><span class="mf">12</span><span class="p">.</span><span class="n">063Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">11.056</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">12.063</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">194624s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">178019s</span>
</span></span></code></pre></div><h2 id="3-3-matrix-block-parallelization">3. 3. Matrix Block Parallelization</h2>
<p>When directly solving a large matrix, in order to improve the solving efficiency, the large matrix can be divided into small blocks for solving. This can improve the cache hit rate and improve the computing performance to a certain extent.</p>
<h3 id="31-matrix-block-c-implementation">3.1 Matrix block C implementation</h3>
<p>Based on the implementation in 2.1, change the contents of the <code>openmp.c</code> file as follows, and keep the contents of other files unchanged.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//Block size, adjusted according to cache size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BLOCK_SIZE 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#pragma omp parallel for collapse(2) shared(A, B, C)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">i_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">i_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">j_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">j_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">k_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">k_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i_block</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j_block</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">j_end</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k_block</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">k_end</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#pragma omp parallel for collapse(2) shared(A, B, C)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k_block</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k_block</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">i_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">i_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">j_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">j_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">k_end</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">k_block</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i_block</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j_block</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">j_end</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k_block</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">k_end</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s ucrt64 toolchain on Windows, the Release program execution results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">058133s</span><span class="p">(</span><span class="mf">36</span><span class="p">.</span><span class="n">941Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060944s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">237Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060845s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">294Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060216s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">663Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">061135s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">127Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060427s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">539Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">059523s</span><span class="p">(</span><span class="mf">36</span><span class="p">.</span><span class="n">078Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060110s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">726Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">062199s</span><span class="p">(</span><span class="mf">34</span><span class="p">.</span><span class="n">526Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">059708s</span><span class="p">(</span><span class="mf">35</span><span class="p">.</span><span class="n">966Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">35.610</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">36.941</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">060324s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">058133s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">openmp</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/c/openmp/build/openmp_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">065988s</span><span class="p">(</span><span class="mf">32</span><span class="p">.</span><span class="n">544Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">056852s</span><span class="p">(</span><span class="mf">37</span><span class="p">.</span><span class="n">773Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">059504s</span><span class="p">(</span><span class="mf">36</span><span class="p">.</span><span class="n">090Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053153s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">402Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">057459s</span><span class="p">(</span><span class="mf">37</span><span class="p">.</span><span class="n">374Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053974s</span><span class="p">(</span><span class="mf">39</span><span class="p">.</span><span class="n">787Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">055030s</span><span class="p">(</span><span class="mf">39</span><span class="p">.</span><span class="n">024Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053222s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">349Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">054025s</span><span class="p">(</span><span class="mf">39</span><span class="p">.</span><span class="n">750Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053405s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">211Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">38.330</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">40.402</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">056261s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053153s</span>
</span></span></code></pre></div><p>Compared with the loop nesting algorithm, the performance is greatly improved after the block division. The block size is related to the hardware platform, which directly affects the cache hit rate and thus affects the computing performance. A lot of tests are needed to determine the most appropriate block size.</p>
<h3 id="32-matrix-block-fortran-implementation">3.2 Matrix block fortran implementation</h3>
<p>Based on the content of 2.2, only the <code>omp.f90</code> file is changed and the matrix blocking algorithm is added.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="p">,</span><span class="w"> </span><span class="n">bj</span><span class="p">,</span><span class="w"> </span><span class="n">bk</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">! Define block size, adjust according to cache situation
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">   </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp parallel do private(bi, bj, bk, i, j, k, temp) shared(a, b, c, n, block_size)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">   </span><span class="k">do</span><span class="w"> </span><span class="n">bi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="n">bj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bi</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp end parallel do
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="p">,</span><span class="w"> </span><span class="n">bj</span><span class="p">,</span><span class="w"> </span><span class="n">bk</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp parallel do private(bi, bj, bk, i, j, k, temp) shared(a, b, c, n, block_size)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">   </span><span class="k">do</span><span class="w"> </span><span class="n">bi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="n">bj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bi</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">bk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c">!$omp end parallel do
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s ucrt64 toolchain on Windows, the Release program execution results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/openmp-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">091248s</span><span class="p">(</span>  <span class="mf">23</span><span class="p">.</span><span class="n">535Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">082953s</span><span class="p">(</span>  <span class="mf">25</span><span class="p">.</span><span class="n">888Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">080934s</span><span class="p">(</span>  <span class="mf">26</span><span class="p">.</span><span class="n">534Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">078231s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">451Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">076461s</span><span class="p">(</span>  <span class="mf">28</span><span class="p">.</span><span class="n">086Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">078698s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">288Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">077900s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">567Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">079131s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">138Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">083838s</span><span class="p">(</span>  <span class="mf">25</span><span class="p">.</span><span class="n">615Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">078336s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">414Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">26.651</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">28.086</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">080773s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">076461s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">openmp-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/openmp-fortran/build/openmp-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">087275s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">606Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">080483s</span><span class="p">(</span>  <span class="mf">26</span><span class="p">.</span><span class="n">682Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">079304s</span><span class="p">(</span>  <span class="mf">27</span><span class="p">.</span><span class="n">079Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">080373s</span><span class="p">(</span>  <span class="mf">26</span><span class="p">.</span><span class="n">719Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">076651s</span><span class="p">(</span>  <span class="mf">28</span><span class="p">.</span><span class="n">016Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">080497s</span><span class="p">(</span>  <span class="mf">26</span><span class="p">.</span><span class="n">678Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">097153s</span><span class="p">(</span>  <span class="mf">22</span><span class="p">.</span><span class="n">104Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">085253s</span><span class="p">(</span>  <span class="mf">25</span><span class="p">.</span><span class="n">190Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">085751s</span><span class="p">(</span>  <span class="mf">25</span><span class="p">.</span><span class="n">043Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">098205s</span><span class="p">(</span>  <span class="mf">21</span><span class="p">.</span><span class="n">867Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">25.399</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">28.016</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">085094s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">076651s</span>
</span></span></code></pre></div><p>The performance improvement depends on the block size. You can adjust the block size to slowly find the most suitable parameters.</p>
<h3 id="33-matrix-block-rust-implementation">3.3 Matrix block rust implementation</h3>
<p>Similarly, based on 2.3, only the <code>matmul.rs</code> file is changed here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">rayon</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Defining the block size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span><span class="w"> </span><span class="no">BLOCK_SIZE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">par_chunks_mut</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">enumerate</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">c_row</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">bj</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="p">).</span><span class="n">step_by</span><span class="p">(</span><span class="no">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">bk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="p">).</span><span class="n">step_by</span><span class="p">(</span><span class="no">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">bj</span><span class="o">..</span><span class="p">(</span><span class="n">bj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="no">BLOCK_SIZE</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">bk</span><span class="o">..</span><span class="p">(</span><span class="n">bk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="no">BLOCK_SIZE</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c_row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f64</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">par_chunks_mut</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">enumerate</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">c_row</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">bj</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="p">).</span><span class="n">step_by</span><span class="p">(</span><span class="no">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">bk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="p">).</span><span class="n">step_by</span><span class="p">(</span><span class="no">BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">bj</span><span class="o">..</span><span class="p">(</span><span class="n">bj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="no">BLOCK_SIZE</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">bk</span><span class="o">..</span><span class="p">(</span><span class="n">bk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="no">BLOCK_SIZE</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c_row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Compiled using the msvc toolchain under Windows, the Release program has the following effects:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>   
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">03s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">113868s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">859Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">116698s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">402Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">125060s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">172Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">125669s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">088Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">116527s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">429Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">114784s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">709Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">117369s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">297Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">114227s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">800Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">118140s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">177Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">115756s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">552Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">18.249</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">18.859</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">117810s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">113868s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">03s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">rayon-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">120614s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">805Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">128292s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">739Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">122600s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">516Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">118252s</span><span class="p">(</span><span class="mf">18</span><span class="p">.</span><span class="n">160Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127342s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">864Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">121794s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">632Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">130288s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">483Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">137106s</span><span class="p">(</span><span class="mf">15</span><span class="p">.</span><span class="n">663Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">130548s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">450Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">138826s</span><span class="p">(</span><span class="mf">15</span><span class="p">.</span><span class="n">469Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">16.878</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">18.160</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127566s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">118252s</span>
</span></span></code></pre></div><p>The performance improvement is limited compared to C and Fortran, and it takes time to adjust the block size and try out the most appropriate parameters.</p>
<h2 id="4-the-black-magic-of-compilers">4. The Black Magic of Compilers</h2>
<p>In the previous section, we have discussed the algorithm implementation using a simple loop and used some parallel libraries to accelerate the calculation. Now, we will not use parallel libraries but use the Fortran matmul function and the Rust ndarray and mathru libraries to implement matrix multiplication operations, to illustrate the importance of compiler optimization.</p>
<h3 id="41-fortran-built-in-function-matmul">4.1 Fortran built-in function matmul</h3>
<p>The content of <code>main.f90</code> is consistent with that in 2.2. The content of the specific implementation file <code>matmul.f90</code> is as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">real</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p><code>CMakeLists.txt</code> removed openmp related code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">matmul-fortran</span> <span class="s">LANGUAGES</span> <span class="s">Fortran</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_Fortran_STANDARD</span> <span class="s">2008</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.f90</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/matmul.f90</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s ucrt64 toolchain under Windows, the Release program execution results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/matmul-fortran/build/matmul-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>        
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">049251s</span><span class="p">(</span>  <span class="mf">43</span><span class="p">.</span><span class="n">603Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">048811s</span><span class="p">(</span>  <span class="mf">43</span><span class="p">.</span><span class="n">996Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">048778s</span><span class="p">(</span>  <span class="mf">44</span><span class="p">.</span><span class="n">026Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">048698s</span><span class="p">(</span>  <span class="mf">44</span><span class="p">.</span><span class="n">098Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046176s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">506Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046269s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">413Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046297s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">385Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046634s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">049Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046198s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">484Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046255s</span><span class="p">(</span>  <span class="mf">46</span><span class="p">.</span><span class="n">428Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">45.399</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">46.506</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">047337s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">046176s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="p">.</span><span class="s2">&#34;D:/example/efficiency_v3/fortran/matmul-fortran/build/matmul-fortran_gnu_gnu_15.1.0.exe&#34;</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"> <span class="n">Using</span> <span class="n">real</span><span class="p">*</span><span class="mf">64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">       <span class="mf">1</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">094482s</span><span class="p">(</span>  <span class="mf">22</span><span class="p">.</span><span class="n">729Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">2</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">093445s</span><span class="p">(</span>  <span class="mf">22</span><span class="p">.</span><span class="n">981Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">3</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">090847s</span><span class="p">(</span>  <span class="mf">23</span><span class="p">.</span><span class="n">638Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">4</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">089272s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">055Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">5</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088472s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">273Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">6</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088759s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">195Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">7</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088489s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">268Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">8</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088787s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">187Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="mf">9</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">089572s</span><span class="p">(</span>  <span class="mf">23</span><span class="p">.</span><span class="n">975Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="mf">10</span> <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088757s</span><span class="p">(</span>  <span class="mf">24</span><span class="p">.</span><span class="n">195Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">23.850</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span>   <span class="mf">24.273</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">090088s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span>   <span class="mf">0</span><span class="p">.</span><span class="n">088472s</span>
</span></span></code></pre></div><p>Hyperthreading is not used, but it beats the combination of previous loop nesting and openmp methods. This may explain why C has been popular for decades but still cannot replace Fortran.</p>
<h3 id="42-rust-implemented-through-the-ndarray-library">4.2 Rust implemented through the ndarray library</h3>
<p>ndarray is a library used by Rust to process arrays, with a built-in matrix transposition function. Unlike the matrix stored in a one-dimensional array implemented in 2.3, using the ndarray library requires converting the one-dimensional array into a two-dimensional one.</p>
<p>The <code>main.rs</code> file is the same as in 2.3, and the <code>matmul.rs</code> file is as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">ndarray</span>::<span class="p">{</span><span class="n">Array2</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayView2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayView2</span>::<span class="n">from_shape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayView2</span>::<span class="n">from_shape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array2</span>::<span class="o">&lt;</span><span class="kt">f32</span><span class="o">&gt;</span>::<span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c_mat</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">c_mat</span><span class="p">.</span><span class="n">as_slice</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f64</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayView2</span>::<span class="n">from_shape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayView2</span>::<span class="n">from_shape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array2</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span>::<span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c_mat</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">c_mat</span><span class="p">.</span><span class="n">as_slice</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The content of the <code>Cargo.toml</code> file is as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;ndarray-rs&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">edition</span> <span class="p">=</span> <span class="s2">&#34;2024&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">clap</span> <span class="p">=</span> <span class="p">{</span> <span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;4.5.40&#34;</span><span class="p">,</span> <span class="nx">features</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;derive&#34;</span><span class="p">]</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">ndarray</span> <span class="p">=</span> <span class="s2">&#34;0.16.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">rand</span> <span class="p">=</span> <span class="s2">&#34;0.9.1&#34;</span>
</span></span></code></pre></div><p>Compiled using the msvc toolchain under Windows, the Release program has the following effects:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">ndarray-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">04s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">ndarray-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019414s</span><span class="p">(</span><span class="mf">110</span><span class="p">.</span><span class="n">617Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">020280s</span><span class="p">(</span><span class="mf">105</span><span class="p">.</span><span class="n">891Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019639s</span><span class="p">(</span><span class="mf">109</span><span class="p">.</span><span class="n">346Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">020076s</span><span class="p">(</span><span class="mf">106</span><span class="p">.</span><span class="n">966Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019702s</span><span class="p">(</span><span class="mf">109</span><span class="p">.</span><span class="n">000Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019438s</span><span class="p">(</span><span class="mf">110</span><span class="p">.</span><span class="n">479Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019336s</span><span class="p">(</span><span class="mf">111</span><span class="p">.</span><span class="n">061Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">018605s</span><span class="p">(</span><span class="mf">115</span><span class="p">.</span><span class="n">426Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">018340s</span><span class="p">(</span><span class="mf">117</span><span class="p">.</span><span class="n">096Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019040s</span><span class="p">(</span><span class="mf">112</span><span class="p">.</span><span class="n">787Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">110.867</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">117.096</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">019387s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">018340s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">ndarray-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">04s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">ndarray-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041449s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">811Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039612s</span><span class="p">(</span><span class="mf">54</span><span class="p">.</span><span class="n">213Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039634s</span><span class="p">(</span><span class="mf">54</span><span class="p">.</span><span class="n">183Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">040022s</span><span class="p">(</span><span class="mf">53</span><span class="p">.</span><span class="n">657Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">038563s</span><span class="p">(</span><span class="mf">55</span><span class="p">.</span><span class="n">687Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">037992s</span><span class="p">(</span><span class="mf">56</span><span class="p">.</span><span class="n">524Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">038128s</span><span class="p">(</span><span class="mf">56</span><span class="p">.</span><span class="n">324Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">038157s</span><span class="p">(</span><span class="mf">56</span><span class="p">.</span><span class="n">280Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">038750s</span><span class="p">(</span><span class="mf">55</span><span class="p">.</span><span class="n">419Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">038102s</span><span class="p">(</span><span class="mf">56</span><span class="p">.</span><span class="n">361Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">55.046</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">56.524</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039041s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">037992s</span>
</span></span></code></pre></div><p>It also does not use hyperthreading, and it beats the previous loop nesting and rayon implementation combination. If the time difference caused by the conversion between one-dimensional arrays and two-dimensional arrays is not taken into account, the actual computing performance will actually be higher.</p>
<h3 id="43-rust-implemented-through-the-mathru-library">4.3 Rust implemented through the mathru library</h3>
<p>Mathru is another Rust math library that provides many commonly used linear algebra calculation functions. The underlying algorithm can be implemented using Intel MKL or OpenBLAS.</p>
<p>Similarly, <code>main.rs</code> is not shown, and only the <code>matmul.rs</code> file is changed, as shown below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">mathru</span>::<span class="n">algebra</span>::<span class="n">linear</span>::<span class="n">matrix</span>::<span class="n">General</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">General</span>::<span class="n">new</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">General</span>::<span class="n">new</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a_mat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b_mat</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_mat</span><span class="p">.</span><span class="n">convert_to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f64</span><span class="p">],</span><span class="w"> </span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">f64</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">General</span>::<span class="n">new</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">General</span>::<span class="n">new</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c_mat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_mat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b_mat</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_mat</span><span class="p">.</span><span class="n">convert_to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The <code>Cargo.toml</code> file is as follows. The default implementation of mathru is used here, and Intel mkl or openblas is not used.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">package</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;mathru-rs&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">edition</span> <span class="p">=</span> <span class="s2">&#34;2024&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">clap</span> <span class="p">=</span> <span class="p">{</span> <span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;4.5.40&#34;</span><span class="p">,</span> <span class="nx">features</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;derive&#34;</span><span class="p">]</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">mathru</span> <span class="p">=</span> <span class="s2">&#34;0.15.5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">rand</span> <span class="p">=</span> <span class="s2">&#34;0.9.1&#34;</span>
</span></span></code></pre></div><p>Compiled using the msvc tool chain under Windows, the Release program execution effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">mathru-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">05s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">mathru-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f32</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">009277s</span><span class="p">(</span><span class="mf">231</span><span class="p">.</span><span class="n">472Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">007753s</span><span class="p">(</span><span class="mf">277</span><span class="p">.</span><span class="n">002Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">009030s</span><span class="p">(</span><span class="mf">237</span><span class="p">.</span><span class="n">817Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">007585s</span><span class="p">(</span><span class="mf">283</span><span class="p">.</span><span class="n">111Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">008559s</span><span class="p">(</span><span class="mf">250</span><span class="p">.</span><span class="n">904Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">009235s</span><span class="p">(</span><span class="mf">232</span><span class="p">.</span><span class="n">530Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">008425s</span><span class="p">(</span><span class="mf">254</span><span class="p">.</span><span class="n">900Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">007451s</span><span class="p">(</span><span class="mf">288</span><span class="p">.</span><span class="n">214Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">007609s</span><span class="p">(</span><span class="mf">282</span><span class="p">.</span><span class="n">237Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">008545s</span><span class="p">(</span><span class="mf">251</span><span class="p">.</span><span class="n">318Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">258.950</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">288.214</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">008347s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">007451s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">rust</span><span class="p">\</span><span class="nb">mathru-rs</span><span class="p">&gt;</span> <span class="n">cargo</span> <span class="n">run</span> <span class="p">-</span><span class="n">-release</span> <span class="p">--</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span>
</span></span><span class="line"><span class="cl">    <span class="n">Finished</span> <span class="p">`</span><span class="n">release</span><span class="p">`</span> <span class="n">profile</span> <span class="p">[</span><span class="no">optimized</span><span class="p">]</span> <span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">in</span> <span class="mf">0</span><span class="p">.</span><span class="n">05s</span>
</span></span><span class="line"><span class="cl">     <span class="n">Running</span> <span class="p">`</span><span class="n">target</span><span class="p">\</span><span class="n">release</span><span class="p">\</span><span class="nb">mathru-rs</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-d</span><span class="p">`</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">f64</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">016261s</span><span class="p">(</span><span class="mf">132</span><span class="p">.</span><span class="n">063Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">016281s</span><span class="p">(</span><span class="mf">131</span><span class="p">.</span><span class="n">904Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">015308s</span><span class="p">(</span><span class="mf">140</span><span class="p">.</span><span class="n">282Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">016065s</span><span class="p">(</span><span class="mf">133</span><span class="p">.</span><span class="n">672Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">016702s</span><span class="p">(</span><span class="mf">128</span><span class="p">.</span><span class="n">578Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">014126s</span><span class="p">(</span><span class="mf">152</span><span class="p">.</span><span class="n">019Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">017731s</span><span class="p">(</span><span class="mf">121</span><span class="p">.</span><span class="n">116Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">020181s</span><span class="p">(</span><span class="mf">106</span><span class="p">.</span><span class="n">409Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">015631s</span><span class="p">(</span><span class="mf">137</span><span class="p">.</span><span class="n">388Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">015181s</span><span class="p">(</span><span class="mf">141</span><span class="p">.</span><span class="n">459Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">132.489</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">152.019</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">016347s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">014126s</span>
</span></span></code></pre></div><p>Without using multithreading, it is much faster than ndarray, which seems to indicate that some optimizations are done at the bottom layer. Similarly, if we do not consider the conversion between one-dimensional and two-dimensional arrays, the actual computing performance should be higher.</p>
<h2 id="5-summarize">5. Summarize</h2>
<p>C, Fortran and Rust matrix multiplication programs accelerated by parallel libraries such as OpenMP and Rayon use the same algorithm. The performance of matrix multiplication will be slightly different according to the implementation of different platforms and compilers, but generally they are in the same order of magnitude. This simple loop parallel acceleration calculation method is suitable for occasions with small matrix size. As the matrix size increases, the overall computing performance shows a decreasing trend.</p>
<p>Even if the block matrix + parallel library method is used to improve the cache hit rate, the performance improvement is still limited. Moreover, the matrix block size is related to the cache size of the computing platform, and a lot of tests are required to call out the appropriate block parameters.</p>
<p>The matrix multiplication function implemented using Fortran&rsquo;s Matmul and Rust&rsquo;s mathematical library, even without parallel acceleration, still leads the implementation of simple loop parallel acceleration in matrix multiplication performance. This just shows the importance of optimizing the underlying algorithm.</p>
<p>In the field of high-performance computing, in addition to the OpenMP parallel acceleration method, there are also BLAS, CUDA, MPI, etc., which will be further demonstrated in future articles.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://en.wikipedia.org/wiki/Matrix_multiplication" target="_blank" rel="noopener">Matrix multiplication</a>
&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.cnblogs.com/hdk1993/p/4552534.html" target="_blank" rel="noopener">矩阵乘法的Strassen算法详解</a>
&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://zhuanlan.zhihu.com/p/667189867" target="_blank" rel="noopener">矩阵乘法并行化（使用OpenMP）</a>
&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

      </article>

      


  
<script type="text/javascript">
  (function() {
    const themeToggle = document.querySelector('.darkmode-toggle input');
    const light = 'light';
    const dark = 'dark';
    let isDark = localStorage.theme === dark || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
    let theme = isDark ? dark : light;

    const s = document.createElement('script');
    s.type = 'text/javascript';
    const dataset = {
        repo: 'AndrewMoa2005\/AndrewMoa2005.github.io',
        repoId: 'R_kgDOOSI4_A',
        category: 'General',
        categoryId: 'DIC_kwDOOSI4_M4Co1Kf',
        mapping: 'pathname',
        reactionsEnabled: '1',
        emitMetadata: '0',
        theme: theme,
        lang: 'en',
    };
    s.src = 'https://giscus.app/client.js';
    s.crossorigin = 'anonymous';
    s.async = true;
    Object.entries(dataset).forEach(function(a) {
        return s.dataset[a[0]] = a[1];
    });

    const curScriptElement = document.currentScript;
    curScriptElement.parentNode.insertBefore(s, curScriptElement);

    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }

    themeToggle.addEventListener('change', function () {
      if (this.checked) {
        theme = dark;
      } else {
        theme = light;
      }
      sendMessage({
        setConfig: {
          theme: theme,
        }
      });
    });
  })();
</script>
  



    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
  
  
  
  
  
  
  
  
    <a href="https://github.com/AndrewMoa2005" target="_blank" title="Github" class="flex flex-row mr-2">
      <span class="hidden">Github</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
 </i>
    </a>
  
  
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2025 Andrew Moa
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/main.min.65ca5b0808abf278fcec5d424701ebf0b4bc46a737129cd5e57fdb739f463e79.js"></script>

<div class="hidden top-1 right-1" id="code-copy">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
</svg>

  </i>
</div>
<div class="hidden top-1 right-1" id="code-copy-done">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M5 12l5 5l10 -10" />
</svg>

  </i>
</div><script src="/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js"></script>





</body>
</html>
