<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <title>Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration :: Andrew Moa Blog Site - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="MPI is a parallel computing protocol and is currently the most commonly used interface program for high-performance computing clusters. MPI communicates through inter-process messages and can call multiple cores across nodes to perform parallel computing, which is not available in OpenMP. MPI is implemented on different platforms, such as MS-MPI and Intel MPI under Windows, OpenMPI and MPICH under Linux, etc.
1. MPI parallel acceleration loop calculation 1.1 C Implementation MPI needs to initialize the main program interface and establish a message broadcast mechanism; at the same time, the array to be calculated is divided and broadcast to different processes. In the past, these operations were implemented internally by OpenMP or other parallel libraries, and programmers did not need to care about how the underlying implementation was implemented. However, using MPI requires programmers to manually allocate the global and local space of each process and control the broadcast of each message, which undoubtedly increases the additional learning cost.
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="https://andrewmoa.site/post/2025-06-25-matrix_multiplication-3/">
  <meta property="og:site_name" content="Andrew Moa Blog Site">
  <meta property="og:title" content="Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration">
  <meta property="og:description" content="MPI is a parallel computing protocol and is currently the most commonly used interface program for high-performance computing clusters. MPI communicates through inter-process messages and can call multiple cores across nodes to perform parallel computing, which is not available in OpenMP. MPI is implemented on different platforms, such as MS-MPI and Intel MPI under Windows, OpenMPI and MPICH under Linux, etc.
1. MPI parallel acceleration loop calculation 1.1 C Implementation MPI needs to initialize the main program interface and establish a message broadcast mechanism; at the same time, the array to be calculated is divided and broadcast to different processes. In the past, these operations were implemented internally by OpenMP or other parallel libraries, and programmers did not need to care about how the underlying implementation was implemented. However, using MPI requires programmers to manually allocate the global and local space of each process and control the broadcast of each message, which undoubtedly increases the additional learning cost.">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-06-25T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-07-22T16:58:14+08:00">
    <meta property="article:tag" content="C&#43;&#43;">
    <meta property="article:tag" content="Fortran">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration">
  <meta name="twitter:description" content="MPI is a parallel computing protocol and is currently the most commonly used interface program for high-performance computing clusters. MPI communicates through inter-process messages and can call multiple cores across nodes to perform parallel computing, which is not available in OpenMP. MPI is implemented on different platforms, such as MS-MPI and Intel MPI under Windows, OpenMPI and MPICH under Linux, etc.
1. MPI parallel acceleration loop calculation 1.1 C Implementation MPI needs to initialize the main program interface and establish a message broadcast mechanism; at the same time, the array to be calculated is divided and broadcast to different processes. In the past, these operations were implemented internally by OpenMP or other parallel libraries, and programmers did not need to care about how the underlying implementation was implemented. However, using MPI requires programmers to manually allocate the global and local space of each process and control the broadcast of each message, which undoubtedly increases the additional learning cost.">


<link rel="canonical" href="https://andrewmoa.site/post/2025-06-25-matrix_multiplication-3/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.min.8f52268ce38691bd84eeee05121a11e2bc53c0e9f7fa97e2b147af29c8a627e1.css">





      <script async src="https://www.googletagmanager.com/gtag/js?id=G-75W5D7R0V1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-75W5D7R0V1');
        }
      </script>




  
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Andrew Moa"},"dateModified":"2025-07-22T16:58:14+08:00","datePublished":"2025-06-25T00:00:00Z","description":"MPI is a parallel computing protocol and is currently the most commonly used interface program for high-performance computing clusters. MPI communicates through inter-process messages and can call multiple cores across nodes to perform parallel computing, which is not available in OpenMP. MPI is implemented on different platforms, such as MS-MPI and Intel MPI under Windows, OpenMPI and MPICH under Linux, etc.\n1. MPI parallel acceleration loop calculation 1.1 C Implementation MPI needs to initialize the main program interface and establish a message broadcast mechanism; at the same time, the array to be calculated is divided and broadcast to different processes. In the past, these operations were implemented internally by OpenMP or other parallel libraries, and programmers did not need to care about how the underlying implementation was implemented. However, using MPI requires programmers to manually allocate the global and local space of each process and control the broadcast of each message, which undoubtedly increases the additional learning cost.\n","image":"/images/code-bg.jpg","name":"Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration","url":"https://andrewmoa.site/post/2025-06-25-matrix_multiplication-3/"}
</script>

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/logo.svg" alt="logo">
    </a>
  </div>
  
  <h1 class="hidden md:flex flex-col justify-center mx-2">
    <a href="/" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">
      Andrew Moa Blog Site
    </a>
  </h1>
  
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">Open main menu</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-xs md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600"
            href="/post/" title="Post">Post</a>
        </li>
      
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/about/" title="About">About</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none">
    <div class="h-full static">
      <button id="navbar-lang-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
        <span class="sr-only">Open language switcher</span>
        <i class="w-8 h-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c0 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>

        </i>
      </button>
      <div class="absolute hidden top-16 z-50" id="navbar-lang">
        <ul class="flex flex-col rounded-xs px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
          <li class="">
            <span class="block px-3 py-3 cursor-default hover:text-emerald-600">English</span>
            </li>
        
          <li class="">
            <a class="block px-3 py-3 hover:text-emerald-600"
              href="/zh-cn/post/2025-06-25-matrix_multiplication-3/" title="中文">中文</a></li>
        
        </ul>
      </div>
    </div>
  </div>
  
  <div class="flex-none md:hidden">
    <a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="relative flex items-center gap-1 px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="absolute z-10 w-15 h-8 rounded-full bg-white dark:bg-gray-700"></div>
      <i class="h-6 w-6 z-20 ml-1 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:invisible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

      </i>
      <i class="h-6 w-6 z-20 mr-1 flex-none rounded-full place-self-center invisible peer-checked:visible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

      </i>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div id="progress" class="fixed top-0 left-0 w-full h-1 bg-blue-500"></div>
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/post/2025-06-25-matrix_multiplication-3/">
        <figure>
    <img class="w-full object-cover h-36 md:h-48 xl:h-60" src="/images/code-bg.jpg"
      alt="Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration" title="Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration"
      loading="lazy"
    >
  </figure>
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/post/2025-06-25-matrix_multiplication-3/">Matrix multiplication operation (Ⅲ) - using MPI parallel acceleration</a>
      </h1>

      
      
  <ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300">
    
      
      <li>
        <a href="/categories/code/"
          class="text-sm mr-2 px-2 py-1 rounded-sm border border-emerald-800 bg-emerald-800 text-slate-50">
          Code
        </a>
      </li>
      
    
    
      
      <li>
        <a href="/tags/c&#43;&#43;/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">C&#43;&#43;</span>
        </a>
      </li>
      
      <li>
        <a href="/tags/fortran/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">Fortran</span>
        </a>
      </li>
      
    
  </ul>



      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  
  
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
   <path d="M16 3v4"></path>
   <path d="M8 3v4"></path>
   <path d="M4 11h16"></path>
   <path d="M11 15h1"></path>
   <path d="M12 15v3"></path>
</svg>

    </i>
    <time datetime="2025-06-25T00:00:00&#43;00:00">
      2025-06-25
    </time>
  </div>

  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      34 minutes to read
    </span>
  </div>
</div>

      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>

    </i>
    <span>Andrew Moa</span>
  </div>
</div>

      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>Table of Contents</h2>
          <aside><nav id="TableOfContents">
  <ul>
    <li><a href="#1-mpi-parallel-acceleration-loop-calculation">1. MPI parallel acceleration loop calculation</a>
      <ul>
        <li><a href="#11-c-implementation">1.1 C Implementation</a></li>
        <li><a href="#12-fortran-implementation">1.2 Fortran Implementation</a></li>
      </ul>
    </li>
    <li><a href="#2-mpi-accelerates-matrix-block-operations">2. MPI accelerates matrix block operations</a>
      <ul>
        <li><a href="#21-c-implementation">2.1 C Implementation</a></li>
        <li><a href="#22-fortran-implementation">2.2 Fortran Implementation</a></li>
      </ul>
    </li>
    <li><a href="#3-mpi-parallelism-and-underlying-optimization-acceleration">3. MPI parallelism and underlying optimization acceleration</a>
      <ul>
        <li><a href="#31-fortran-compiler-optimization">3.1 fortran compiler optimization</a></li>
        <li><a href="#32-blas-acceleration">3.2 BLAS acceleration</a></li>
      </ul>
    </li>
    <li><a href="#4-summarize">4. Summarize</a></li>
  </ul>
</nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <p>MPI is a parallel computing protocol and is currently the most commonly used interface program for high-performance computing clusters. MPI communicates through inter-process messages and can call multiple cores across nodes to perform parallel computing, which is not available in OpenMP. MPI is implemented on different platforms, such as MS-MPI and Intel MPI under Windows, OpenMPI and MPICH under Linux, etc.</p>
<h2 id="1-mpi-parallel-acceleration-loop-calculation">1. MPI parallel acceleration loop calculation</h2>
<h3 id="11-c-implementation">1.1 C Implementation</h3>
<p>MPI needs to initialize the main program interface and establish a message broadcast mechanism; at the same time, the array to be calculated is divided and broadcast to different processes. In the past, these operations were implemented internally by OpenMP or other parallel libraries, and programmers did not need to care about how the underlying implementation was implemented. However, using MPI requires programmers to manually allocate the global and local space of each process and control the broadcast of each message, which undoubtedly increases the additional learning cost.</p>
<p>Here, the <code>main.c</code> file is modified as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;mpi.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX(a, b) ((a) &gt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MIN(a, b) ((a) &lt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Initialize matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Execute matrix multiply and print results
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">mpi_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">volatile</span> <span class="kt">float</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">local_c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">total_cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">check_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The main process allocates memory for the complete matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Generate checksum value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">check_value</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_col</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Broadcast verification row and column index and verification value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocate local matrix space for each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">local_A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_A</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">local_c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Distribute the rows of matrix A to each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="o">*</span><span class="n">sendcounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="o">*</span><span class="n">displs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">rows_per_process</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">displs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Scatterv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// All processes require the complete matrix B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">full_B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">full_B</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for full_B</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">full_B</span><span class="p">,</span> <span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Use MPI_Reduce to sum the cpu_time of all processes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Calculate the average
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">total_cpu_time</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Broadcast the average value to all processes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span> <span class="c1">// Force flushing of standard output buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Collect the local results of all processes to the main process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for c matrix</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Gatherv</span><span class="p">(</span><span class="n">local_c</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Main process performs verification
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">result_value</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">fabs</span><span class="p">(</span><span class="n">result_value</span> <span class="o">-</span> <span class="n">check_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Verification failed at iteration %d: expected %.6f, got %.6f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">check_value</span><span class="p">,</span> <span class="n">result_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Free memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">sendcounts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">displs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">full_B</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">mpi_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">volatile</span> <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">local_c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">total_cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">check_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The main process allocates memory for the complete matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Generate checksum value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">check_value</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_col</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Broadcast verification row and column index and verification value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocate local matrix space for each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">local_A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_A</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">local_c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Distribute the rows of matrix A to each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="o">*</span><span class="n">sendcounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="o">*</span><span class="n">displs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">rows_per_process</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">displs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Scatterv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// All processes require the complete matrix B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">full_B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">full_B</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for full_B</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">full_B</span><span class="p">,</span> <span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Use MPI_Reduce to sum the cpu_time of all processes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Calculate the average
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">total_cpu_time</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Broadcast the average value to all processes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span> <span class="c1">// Force flushing of standard output buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Collect the local results of all processes to the main process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for c matrix</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Gatherv</span><span class="p">(</span><span class="n">local_c</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Main process performs verification
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">result_value</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">fabs</span><span class="p">(</span><span class="n">result_value</span> <span class="o">-</span> <span class="n">check_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.000001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Verification failed at iteration %d: expected %.6f, got %.6f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">check_value</span><span class="p">,</span> <span class="n">result_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Free memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">sendcounts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">displs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">full_B</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>                                <span class="c1">// Default matrix size exponent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">loop_num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>                          <span class="c1">// Number of iterations for averaging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">ave_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">max_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// Average and maximum Gflops
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">ave_time</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">;</span>     <span class="c1">// Average and minimum time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">use_double</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                        <span class="c1">// Default to float precision
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Help message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-h&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--help&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -n SIZE      Specify matrix size, like 2^SIZE (default: 10)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -l LOOP_NUM  Specify number of iterations (default: 5)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -float       Use float precision (default)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -double      Use double precision</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -h, --help   Show this help message</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Parse -n, -l, -float, -double options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">double_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">float_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">argi</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">argi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-n&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">n</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-l&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop_num</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-double&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">double_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-float&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">float_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">double_flag</span> <span class="o">&amp;&amp;</span> <span class="n">float_flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error: Cannot specify both -double and -float options.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">use_double</span> <span class="o">=</span> <span class="n">double_flag</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">use_double</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using double precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">mpi_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using float precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">mpi_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Gflops: %.3f, Max Gflops: %.3f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_gflops</span><span class="p">,</span> <span class="n">max_gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Time: %.6fs, Min Time: %.6fs</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_time</span><span class="p">,</span> <span class="n">min_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In order to ensure that there are no errors in the merged matrix, a random coordinate verification mechanism is added to the main program.</p>
<p>The <code>mpi.c</code> file is the specific implementation of the loop nested matrix operation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Matrix multiplication operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Matrix multiplication operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>CMakeLists.txt</code> configuration file sets how to include the mpi header file. The compilation here is done on the Windows platform, and the corresponding mpi library is ms-mpi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">mpi</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">CXX</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">20</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi.c</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>Compile using MSYS2&rsquo;s ucrt64 on the Windows platform and output the Release program execution effect as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235279s</span><span class="p">(</span><span class="mf">9</span><span class="p">.</span><span class="n">127Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">245679s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">741Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">252880s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">492Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">253803s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">461Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235253s</span><span class="p">(</span><span class="mf">9</span><span class="p">.</span><span class="n">128Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">261678s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">207Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">261258s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">220Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">256560s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">370Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">254379s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">442Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">271509s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">909Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">8.510</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">9.128</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">252828s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235253s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">317128s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">772Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">316111s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">793Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">320794s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">694Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">334887s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">413Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">328439s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">538Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">326553s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">576Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">321168s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">686Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">322008s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">669Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">330364s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">500Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314038s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">838Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.648</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.838</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">323149s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314038s</span>
</span></span></code></pre></div><p>The CPU of the computing machine is AMD AI 9 365w, with 10 cores and 20 threads. Hyperthreading is used here, and the overall performance is similar to that of OpenMP. The number of computing processes can be controlled through the command line. Since each process needs to allocate local storage space, the more computing processes there are, the greater the memory overhead.</p>
<h3 id="12-fortran-implementation">1.2 Fortran Implementation</h3>
<p>Fortran also provides MPI implementation, and both MS-MPI and OpenMPI provide Fortran interfaces. Due to space limitations, the main program source code here still uses the same <code>main.c</code> as in the previous section. The matrix multiplication part is implemented in Fortran, and the program functions are implemented by mixed programming of Fortran and C.</p>
<p>The matrix multiplication calculation related functions are defined in the Fortran source file <code>mpi2c.f90</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_float&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Initialize the result matrix
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Matrix multiplication calculation
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_double&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Initialize the result matrix
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Matrix multiplication calculation
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>Since the C program interface stores the two-dimensional matrix in a one-dimensional array, in order for the Fortran program to read the matrix information stored in the one-dimensional array normally, it is necessary to define the conversion from the one-dimensional array to the two-dimensional array and open up new storage space. In order to facilitate interface reuse, the relevant content of the array conversion is defined in the calculation function, which will bring additional performance overhead.</p>
<p>The <code>CMakeLists.txt</code> configuration file itself has not changed much, and still contains the C mpi header file, but the settings for activating the Fortran language support are added.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">mpi-fortran</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">Fortran</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_Fortran_STANDARD</span> <span class="s">2008</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi2c.f90</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>Compiled using MSYS2&rsquo;s ucrt64 toolchain under Windows, the Release program runs as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">mpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">mpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">mpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078928s</span><span class="p">(</span><span class="mf">27</span><span class="p">.</span><span class="n">208Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">089289s</span><span class="p">(</span><span class="mf">24</span><span class="p">.</span><span class="n">051Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082848s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">921Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">080060s</span><span class="p">(</span><span class="mf">26</span><span class="p">.</span><span class="n">823Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">084739s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">342Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083975s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">573Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">085056s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">248Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083494s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">720Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082314s</span><span class="p">(</span><span class="mf">26</span><span class="p">.</span><span class="n">089Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082700s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">967Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">25.794</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">27.208</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083340s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078928s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">mpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">mpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">mpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126719s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">947Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127700s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">817Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126309s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">002Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">124125s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">301Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">121543s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">668Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">129106s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">634Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">129957s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">525Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">128702s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">686Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127478s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">846Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">125188s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">154Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">16.958</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">17.668</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126683s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">121543s</span>
</span></span></code></pre></div><p>The above is the result of running on the same processor as 1.1. Fortran arrays use a column-first storage method that is different from C. The cache hit rate is improved, which is beneficial to improving matrix operation performance.</p>
<h2 id="2-mpi-accelerates-matrix-block-operations">2. MPI accelerates matrix block operations</h2>
<h3 id="21-c-implementation">2.1 C Implementation</h3>
<p>The above results reveal that cache performance has a great impact on matrix operations. In order to improve the cache hit rate, we try to use the matrix block algorithm to see if it can improve the computing performance of the C language program.</p>
<p>The main program <code>main.c</code> remains unchanged as before. Only <code>mpi.c</code> is changed here to add the block calculation function based on the original loop nested calculation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//Block size, can be adjusted according to cache size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BLOCK_SIZE 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize local_C to 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Matrix block multiplication
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bi</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">bi</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bj</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bj</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bk</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bk</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Calculation within the block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">end_i</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bi</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">rows_per_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_j</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bj</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_k</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bk</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end_j</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">bk</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">end_k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sum</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize local_C to 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Matrix block multiplication
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bi</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">bi</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bj</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bj</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bk</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bk</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Calculation within the block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">end_i</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bi</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">rows_per_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_j</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bj</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_k</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bk</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end_j</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">bk</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">end_k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sum</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The configuration file <code>CMakeLists.txt</code> is the same as in 1.1.</p>
<p>Compiled using MSYS2&rsquo;s ucrt64 toolchain under Windows, the program execution effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">blockmpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">blockmpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">blockmpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>        
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039390s</span><span class="p">(</span><span class="mf">54</span><span class="p">.</span><span class="n">519Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041973s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">164Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044693s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">050Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042822s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">149Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044406s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">361Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041931s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">215Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042498s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">531Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041639s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">573Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042505s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">523Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043471s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">401Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">50.548</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">54.519</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042533s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039390s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">blockmpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">blockmpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">blockmpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041856s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">307Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">045559s</span><span class="p">(</span><span class="mf">47</span><span class="p">.</span><span class="n">136Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044370s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">400Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043212s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">697Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041711s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">485Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043633s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">217Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042332s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">730Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041305s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">991Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041940s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">203Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">040975s</span><span class="p">(</span><span class="mf">52</span><span class="p">.</span><span class="n">410Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">50.358</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">52.410</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042689s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">040975s</span>
</span></span></code></pre></div><p>The block size is set to 8 here, which is the optimal result obtained based on a large number of tests. When implementing on other platforms, it is necessary to test the hardware of the platform to determine the most appropriate block size.</p>
<h3 id="22-fortran-implementation">2.2 Fortran Implementation</h3>
<p>Next, use Fortran to implement the block matrix MPI acceleration function to see if the performance is improved.</p>
<p><code>main.c</code> and <code>CMakeLists.txt</code> are basically the same as 1.2, only the <code>mpi2c.f90</code> file is changed to add block content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_float&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="c">! Block size can be adjusted according to actual conditions
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Initialize the result matrix
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 分块矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_double&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="c">! Block size can be adjusted according to actual conditions
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Initialize the result matrix
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 分块矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>Under Windows, use MSYS2&rsquo;s ucrt64 tool chain to compile and output the Release program. The execution effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">blockmpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">blockmpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">blockmpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050200s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">779Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050326s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">671Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">049548s</span><span class="p">(</span><span class="mf">43</span><span class="p">.</span><span class="n">341Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050283s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">708Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">048627s</span><span class="p">(</span><span class="mf">44</span><span class="p">.</span><span class="n">163Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">052763s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">700Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">056050s</span><span class="p">(</span><span class="mf">38</span><span class="p">.</span><span class="n">314Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">055364s</span><span class="p">(</span><span class="mf">38</span><span class="p">.</span><span class="n">789Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">051921s</span><span class="p">(</span><span class="mf">41</span><span class="p">.</span><span class="n">361Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053460s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">170Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">41.500</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">44.163</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">051854s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">048627s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">blockmpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">blockmpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">blockmpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078406s</span><span class="p">(</span><span class="mf">27</span><span class="p">.</span><span class="n">389Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">066016s</span><span class="p">(</span><span class="mf">32</span><span class="p">.</span><span class="n">530Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">067229s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">943Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">067948s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">605Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063610s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">760Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063506s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">816Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063981s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">564Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063603s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">764Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">068714s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">252Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063268s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">943Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">32.357</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">33.943</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">066628s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063268s</span>
</span></span></code></pre></div><p>It seems a bit slower than the C implementation, but in fact, the Fortran calculation function adds array conversion, storage space allocation and other functions, which increase the extra running time. Excluding this part of the overhead, the actual calculation performance should be better.</p>
<h2 id="3-mpi-parallelism-and-underlying-optimization-acceleration">3. MPI parallelism and underlying optimization acceleration</h2>
<h3 id="31-fortran-compiler-optimization">3.1 fortran compiler optimization</h3>
<p>Although the previous block matrix has been greatly improved, compared with the compiler&rsquo;s underlying optimization and professional math library mentioned above, this performance is still a bit insufficient. Now try to combine MPI with the underlying optimization of the Fortran compiler to see if the performance can be further improved.</p>
<p><code>main.c</code> and <code>CMakeLists.txt</code> are basically the same as 1.2. Here, the <code>mpi2c.f90</code> file is modified to use the Fortran built-in function matmul to implement matrix operation functions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_float&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Use matmul to perform matrix multiplication
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_double&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a one-dimensional array to a two-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Use matmul to perform matrix multiplication
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! Convert a two-dimensional array to a one-dimensional array
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>Compile using MSYS2&rsquo;s ucrt64 toolchain and execute the Release program under Windows. The results are as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span>        
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">797250s</span><span class="p">(</span><span class="mf">172</span><span class="p">.</span><span class="n">391Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">551850s</span><span class="p">(</span><span class="mf">249</span><span class="p">.</span><span class="n">051Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">560781s</span><span class="p">(</span><span class="mf">245</span><span class="p">.</span><span class="n">085Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">555596s</span><span class="p">(</span><span class="mf">247</span><span class="p">.</span><span class="n">372Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">564455s</span><span class="p">(</span><span class="mf">243</span><span class="p">.</span><span class="n">490Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">552102s</span><span class="p">(</span><span class="mf">248</span><span class="p">.</span><span class="n">938Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">588235s</span><span class="p">(</span><span class="mf">233</span><span class="p">.</span><span class="n">646Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Verification</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mf">7</span><span class="err">:</span> <span class="n">expected</span> <span class="mf">1032.420410</span><span class="p">,</span> <span class="n">got</span> <span class="mf">1032.418823</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">582861s</span><span class="p">(</span><span class="mf">235</span><span class="p">.</span><span class="n">801Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">604666s</span><span class="p">(</span><span class="mf">227</span><span class="p">.</span><span class="n">297Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">615205s</span><span class="p">(</span><span class="mf">223</span><span class="p">.</span><span class="n">404Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">232.647</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">249.051</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">597300s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">551850s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">493319s</span><span class="p">(</span><span class="mf">92</span><span class="p">.</span><span class="n">036Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">031578s</span><span class="p">(</span><span class="mf">133</span><span class="p">.</span><span class="n">232Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">074232s</span><span class="p">(</span><span class="mf">127</span><span class="p">.</span><span class="n">942Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">051967s</span><span class="p">(</span><span class="mf">130</span><span class="p">.</span><span class="n">649Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">135295s</span><span class="p">(</span><span class="mf">121</span><span class="p">.</span><span class="n">060Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">071376s</span><span class="p">(</span><span class="mf">128</span><span class="p">.</span><span class="n">283Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">059316s</span><span class="p">(</span><span class="mf">129</span><span class="p">.</span><span class="n">743Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">061684s</span><span class="p">(</span><span class="mf">129</span><span class="p">.</span><span class="n">454Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">042263s</span><span class="p">(</span><span class="mf">131</span><span class="p">.</span><span class="n">866Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">054022s</span><span class="p">(</span><span class="mf">130</span><span class="p">.</span><span class="n">395Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">125.466</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">133.232</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">107505s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">031578s</span>
</span></span></code></pre></div><p>Compared with the previous matrix block algorithm, it is a great improvement. Notice that a check error occurs in single-precision floating-point operations. The single-precision floating-point check error in the main program is 0.001. Here, the numerical error increases to 0.0016, exceeding the error value set previously. As the matrix size increases, the error of floating-point operations will accumulate. A more reasonable solution is to use higher-precision floating-point operations or increase the check error. The former means that the amount of calculation increases and the performance decreases, and the latter may lead to a decrease in the credibility of the calculation results. Which price to accept needs to be determined based on the calculation occasion.</p>
<h3 id="32-blas-acceleration">3.2 BLAS acceleration</h3>
<p>The blas library demonstrated previously uses openmp to achieve parallel acceleration at the bottom layer, but the openmp library is designed to be only suitable for single-node multi-core acceleration, not for multi-node multi-core operating environments on supercomputers. Is there a way to use the blas library with mpi to achieve cross-node multi-core acceleration at the bottom layer? The implementation method is demonstrated below.</p>
<p>First, the main program file <code>main.c</code> is directly reused as before, and <code>mpi.c</code> is modified to add a call to the openblas function to implement matrix operation functions. Since openblas uses openmp acceleration by default, you need to manually set openblas to run as a single thread.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cblas.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;openblas_config.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Set OpenBLAS to use single thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">openblas_set_num_threads</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Local matrix multiplication using OpenBLAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// C = α * A * B + β * C，which α = 1.0，β = 1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">cblas_sgemm</span><span class="p">(</span><span class="n">CblasRowMajor</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">rows_per_process</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_C</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Set OpenBLAS to use single thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">openblas_set_num_threads</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Count the number of rows processed by each process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Local matrix multiplication using OpenBLAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// C = α * A * B + β * C，which α = 1.0，β = 1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">cblas_dgemm</span><span class="p">(</span><span class="n">CblasRowMajor</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">rows_per_process</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_C</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>CMakeLists.txt</code> configuration file also needs to link to openblas and openmp, otherwise the compilation will report an error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">openblas-mpi</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">CXX</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">20</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Find OpenBLAS
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenMP</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenBLAS</span> <span class="s">CONFIG</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi.c</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenBLAS::OpenBLAS</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenMP::OpenMP_C</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>Compile under Windows, use MSYS2&rsquo;s ucrt64 toolchain and its own openblas, compile and output the Release program, the running effect is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="nb">openblas-mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="nb">openblas-mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">openblas-mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">162794s</span><span class="p">(</span><span class="mf">844</span><span class="p">.</span><span class="n">252Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">178354s</span><span class="p">(</span><span class="mf">770</span><span class="p">.</span><span class="n">595Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">201812s</span><span class="p">(</span><span class="mf">681</span><span class="p">.</span><span class="n">023Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">191400s</span><span class="p">(</span><span class="mf">718</span><span class="p">.</span><span class="n">073Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">186770s</span><span class="p">(</span><span class="mf">735</span><span class="p">.</span><span class="n">872Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">200100s</span><span class="p">(</span><span class="mf">686</span><span class="p">.</span><span class="n">850Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">182761s</span><span class="p">(</span><span class="mf">752</span><span class="p">.</span><span class="n">013Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">181107s</span><span class="p">(</span><span class="mf">758</span><span class="p">.</span><span class="n">882Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">182459s</span><span class="p">(</span><span class="mf">753</span><span class="p">.</span><span class="n">258Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">190692s</span><span class="p">(</span><span class="mf">720</span><span class="p">.</span><span class="n">739Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">742.156</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">844.252</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">185825s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">162794s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="nb">openblas-mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="nb">openblas-mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">openblas-mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">267384s</span><span class="p">(</span><span class="mf">514</span><span class="p">.</span><span class="n">013Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">361675s</span><span class="p">(</span><span class="mf">380</span><span class="p">.</span><span class="n">007Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">338016s</span><span class="p">(</span><span class="mf">406</span><span class="p">.</span><span class="n">605Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">331837s</span><span class="p">(</span><span class="mf">414</span><span class="p">.</span><span class="n">176Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">352789s</span><span class="p">(</span><span class="mf">389</span><span class="p">.</span><span class="n">578Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">346735s</span><span class="p">(</span><span class="mf">396</span><span class="p">.</span><span class="n">381Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">343613s</span><span class="p">(</span><span class="mf">399</span><span class="p">.</span><span class="n">982Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">349749s</span><span class="p">(</span><span class="mf">392</span><span class="p">.</span><span class="n">965Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">340508s</span><span class="p">(</span><span class="mf">403</span><span class="p">.</span><span class="n">629Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">347642s</span><span class="p">(</span><span class="mf">395</span><span class="p">.</span><span class="n">347Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">409.268</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">514.013</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">337995s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">267384s</span>
</span></span></code></pre></div><p>It can be seen that the calculation speed has been greatly improved compared with the previous method. Hyperthreading is not used here, but the result is very close to the effect of using OpenBLAS alone to accelerate the calculation, and the double-precision floating-point calculation performance is even better. Using hyperthreading during the test did not achieve better results, and there is a high probability that the program will crash, which may be caused by the mixing of OpenMP and MPI.</p>
<h2 id="4-summarize">4. Summarize</h2>
<p>Running on a single machine, writing an MPI program requires separate control of memory and message broadcasting, which makes coding and debugging more troublesome and brings additional performance overhead. Compared with OpenMP, it has no performance advantage, but OpenMP has more advantages in coding.</p>
<p>The significance of MPI lies in cross-node multi-core calls on machines such as supercomputing clusters. High-performance computing programs developed using MPI are particularly suitable for acceleration through calls on large clusters and multiple nodes in such occasions.</p>
<p>For high-performance computing programs, using MPI alone does not make much sense for loop acceleration. Computing acceleration should be achieved in conjunction with the optimization of compilers and professional mathematical libraries.</p>
<hr>

      </article>

      


  
<script type="text/javascript">
  (function() {
    const themeToggle = document.querySelector('.darkmode-toggle input');
    const light = 'light';
    const dark = 'dark';
    let isDark = localStorage.theme === dark || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
    let theme = isDark ? dark : light;

    const s = document.createElement('script');
    s.type = 'text/javascript';
    const dataset = {
        repo: 'AndrewMoa2005\/AndrewMoa2005.github.io',
        repoId: 'R_kgDOOSI4_A',
        category: 'General',
        categoryId: 'DIC_kwDOOSI4_M4Co1Kf',
        mapping: 'pathname',
        reactionsEnabled: '1',
        emitMetadata: '0',
        theme: theme,
        lang: 'en',
    };
    s.src = 'https://giscus.app/client.js';
    s.crossorigin = 'anonymous';
    s.async = true;
    Object.entries(dataset).forEach(function(a) {
        return s.dataset[a[0]] = a[1];
    });

    const curScriptElement = document.currentScript;
    curScriptElement.parentNode.insertBefore(s, curScriptElement);

    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }

    themeToggle.addEventListener('change', function () {
      if (this.checked) {
        theme = dark;
      } else {
        theme = light;
      }
      sendMessage({
        setConfig: {
          theme: theme,
        }
      });
    });
  })();
</script>
  



    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
  
  
  
  
  
  
  
  
    <a href="https://github.com/AndrewMoa2005" target="_blank" title="Github" class="flex flex-row mr-2">
      <span class="hidden">Github</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
 </i>
    </a>
  
  
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2025 Andrew Moa
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/main.min.65ca5b0808abf278fcec5d424701ebf0b4bc46a737129cd5e57fdb739f463e79.js"></script>

<div class="hidden top-1 right-1" id="code-copy">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
</svg>

  </i>
</div>
<div class="hidden top-1 right-1" id="code-copy-done">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M5 12l5 5l10 -10" />
</svg>

  </i>
</div><script src="/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js"></script>





</body>
</html>
