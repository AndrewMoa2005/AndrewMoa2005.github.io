<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
  <title>矩阵乘法运算(三)-使用MPI并行加速 :: Andrew Moa Blog Site - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="MPI是一种并行计算协议，也是目前高性能计算集群最为常用的接口程序。MPI通过进程间消息进行通讯，可以跨节点调用多核心执行并行计算，这是OpenMP所不具备的。不同平台均有mpi实现，比如Windows下的MS-MPI和Intel MPI，Linux下的OpenMPI和MPICH等。
1. MPI并行加速循环计算 1.1 C实现 mpi需要对主程序接口进行初始化，建立消息广播机制；同时将需要计算的数组进行分割，广播到不同的进程中。以往这些操作都是openmp或其他并行库内部实现的，程序员不需要关心底层如何实现。但使用mpi需要程序员对每个进程的全局和局部空间进行手动分配，需要控制每个消息的广播，无疑增加了额外的学习成本。
这里将main.c文件修改如下。
#include &#34;mpi.h&#34; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;time.h&gt; #include &lt;math.h&gt; #define MAX(a, b) ((a) &gt; (b) ? (a) : (b)) #define MIN(a, b) ((a) &lt; (b) ? (a) : (b)) extern void matrix_multiply_float(int n, int rank, int size, float local_A[], float B[], float local_C[]); extern void matrix_multiply_double(int n, int rank, int size, double local_A[], double B[], double local_C[]); // Initialize matrix void initialize_matrix_float(int n, float matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (float)(RAND_MAX); } } } void initialize_matrix_double(int n, double matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (double)(RAND_MAX); } } } // Execute matrix multiply and print results int mpi_float(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile float *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; float check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (float *)malloc(dim * dim * sizeof(float)); b = (float *)malloc(dim * dim * sizeof(float)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_float(dim, a); initialize_matrix_float(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 float *local_A = (float *)malloc(rows_per_process * dim * sizeof(float)); local_c = (float *)calloc(rows_per_process * dim, sizeof(float)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_FLOAT, local_A, rows_per_process * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B float *full_B = (float *)malloc(dim * dim * sizeof(float)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(float)); } MPI_Bcast(full_B, dim * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_float(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 float *c = NULL; if (rank == 0) { c = (float *)malloc(dim * dim * sizeof(float)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_FLOAT, c, sendcounts, displs, MPI_FLOAT, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; float result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int mpi_double(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile double *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; double check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (double *)malloc(dim * dim * sizeof(double)); b = (double *)malloc(dim * dim * sizeof(double)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_double(dim, a); initialize_matrix_double(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 double *local_A = (double *)malloc(rows_per_process * dim * sizeof(double)); local_c = (double *)calloc(rows_per_process * dim, sizeof(double)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_DOUBLE, local_A, rows_per_process * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B double *full_B = (double *)malloc(dim * dim * sizeof(double)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(double)); } MPI_Bcast(full_B, dim * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_double(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 double *c = NULL; if (rank == 0) { c = (double *)malloc(dim * dim * sizeof(double)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_DOUBLE, c, sendcounts, displs, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; double result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.000001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int main(int argc, char *argv[]) { int rank; MPI_Init(&amp;argc, &amp;argv); MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); int n = 10; // Default matrix size exponent int loop_num = 5; // Number of iterations for averaging double ave_gflops = 0.0, max_gflops = 0.0; // Average and maximum Gflops double ave_time = 0.0, min_time = 1e9; // Average and minimum time int use_double = 0; // Default to float precision // Help message if (argc == 1 || (argc == 2 &amp;&amp; (strcmp(argv[1], &#34;-h&#34;) == 0 || strcmp(argv[1], &#34;--help&#34;) == 0))) { if (rank == 0) { printf(&#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]\n&#34;, argv[0]); printf(&#34; -n SIZE Specify matrix size, like 2^SIZE (default: 10)\n&#34;); printf(&#34; -l LOOP_NUM Specify number of iterations (default: 5)\n&#34;); printf(&#34; -float Use float precision (default)\n&#34;); printf(&#34; -double Use double precision\n&#34;); printf(&#34; -h, --help Show this help message\n&#34;); } MPI_Finalize(); return 0; } // Parse -n, -l, -float, -double options int double_flag = 0, float_flag = 0; for (int argi = 1; argi &lt; argc; &#43;&#43;argi) { if (strcmp(argv[argi], &#34;-n&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { n = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-l&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { loop_num = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-double&#34;) == 0) { double_flag = 1; } else if (strcmp(argv[argi], &#34;-float&#34;) == 0) { float_flag = 1; } } if (double_flag &amp;&amp; float_flag) { if (rank == 0) { fprintf(stderr, &#34;Error: Cannot specify both -double and -float options.\n&#34;); } MPI_Finalize(); return 1; } use_double = double_flag ? 1 : 0; int dim = (int)pow(2, n); if (use_double) { if (rank == 0) { printf(&#34;Using double precision for matrix multiplication.\n&#34;); } if (!mpi_double(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } else { if (rank == 0) { printf(&#34;Using float precision for matrix multiplication.\n&#34;); } if (!mpi_float(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } if (rank == 0) { printf(&#34;Average Gflops: %.3f, Max Gflops: %.3f\n&#34;, ave_gflops, max_gflops); printf(&#34;Average Time: %.6fs, Min Time: %.6fs\n&#34;, ave_time, min_time); } MPI_Finalize(); return 0; } 为了确保合并之后的矩阵没有错误，主程序中增加了随机坐标校验机制。
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="https://andrewmoa.site/zh-cn/post/2025-06-25-matrix_multiplication-3/">
  <meta property="og:site_name" content="Andrew Moa Blog Site">
  <meta property="og:title" content="矩阵乘法运算(三)-使用MPI并行加速">
  <meta property="og:description" content="MPI是一种并行计算协议，也是目前高性能计算集群最为常用的接口程序。MPI通过进程间消息进行通讯，可以跨节点调用多核心执行并行计算，这是OpenMP所不具备的。不同平台均有mpi实现，比如Windows下的MS-MPI和Intel MPI，Linux下的OpenMPI和MPICH等。
1. MPI并行加速循环计算 1.1 C实现 mpi需要对主程序接口进行初始化，建立消息广播机制；同时将需要计算的数组进行分割，广播到不同的进程中。以往这些操作都是openmp或其他并行库内部实现的，程序员不需要关心底层如何实现。但使用mpi需要程序员对每个进程的全局和局部空间进行手动分配，需要控制每个消息的广播，无疑增加了额外的学习成本。
这里将main.c文件修改如下。
#include &#34;mpi.h&#34; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;time.h&gt; #include &lt;math.h&gt; #define MAX(a, b) ((a) &gt; (b) ? (a) : (b)) #define MIN(a, b) ((a) &lt; (b) ? (a) : (b)) extern void matrix_multiply_float(int n, int rank, int size, float local_A[], float B[], float local_C[]); extern void matrix_multiply_double(int n, int rank, int size, double local_A[], double B[], double local_C[]); // Initialize matrix void initialize_matrix_float(int n, float matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (float)(RAND_MAX); } } } void initialize_matrix_double(int n, double matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (double)(RAND_MAX); } } } // Execute matrix multiply and print results int mpi_float(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile float *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; float check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (float *)malloc(dim * dim * sizeof(float)); b = (float *)malloc(dim * dim * sizeof(float)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_float(dim, a); initialize_matrix_float(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 float *local_A = (float *)malloc(rows_per_process * dim * sizeof(float)); local_c = (float *)calloc(rows_per_process * dim, sizeof(float)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_FLOAT, local_A, rows_per_process * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B float *full_B = (float *)malloc(dim * dim * sizeof(float)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(float)); } MPI_Bcast(full_B, dim * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_float(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 float *c = NULL; if (rank == 0) { c = (float *)malloc(dim * dim * sizeof(float)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_FLOAT, c, sendcounts, displs, MPI_FLOAT, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; float result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int mpi_double(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile double *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; double check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (double *)malloc(dim * dim * sizeof(double)); b = (double *)malloc(dim * dim * sizeof(double)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_double(dim, a); initialize_matrix_double(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 double *local_A = (double *)malloc(rows_per_process * dim * sizeof(double)); local_c = (double *)calloc(rows_per_process * dim, sizeof(double)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_DOUBLE, local_A, rows_per_process * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B double *full_B = (double *)malloc(dim * dim * sizeof(double)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(double)); } MPI_Bcast(full_B, dim * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_double(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 double *c = NULL; if (rank == 0) { c = (double *)malloc(dim * dim * sizeof(double)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_DOUBLE, c, sendcounts, displs, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; double result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.000001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int main(int argc, char *argv[]) { int rank; MPI_Init(&amp;argc, &amp;argv); MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); int n = 10; // Default matrix size exponent int loop_num = 5; // Number of iterations for averaging double ave_gflops = 0.0, max_gflops = 0.0; // Average and maximum Gflops double ave_time = 0.0, min_time = 1e9; // Average and minimum time int use_double = 0; // Default to float precision // Help message if (argc == 1 || (argc == 2 &amp;&amp; (strcmp(argv[1], &#34;-h&#34;) == 0 || strcmp(argv[1], &#34;--help&#34;) == 0))) { if (rank == 0) { printf(&#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]\n&#34;, argv[0]); printf(&#34; -n SIZE Specify matrix size, like 2^SIZE (default: 10)\n&#34;); printf(&#34; -l LOOP_NUM Specify number of iterations (default: 5)\n&#34;); printf(&#34; -float Use float precision (default)\n&#34;); printf(&#34; -double Use double precision\n&#34;); printf(&#34; -h, --help Show this help message\n&#34;); } MPI_Finalize(); return 0; } // Parse -n, -l, -float, -double options int double_flag = 0, float_flag = 0; for (int argi = 1; argi &lt; argc; &#43;&#43;argi) { if (strcmp(argv[argi], &#34;-n&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { n = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-l&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { loop_num = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-double&#34;) == 0) { double_flag = 1; } else if (strcmp(argv[argi], &#34;-float&#34;) == 0) { float_flag = 1; } } if (double_flag &amp;&amp; float_flag) { if (rank == 0) { fprintf(stderr, &#34;Error: Cannot specify both -double and -float options.\n&#34;); } MPI_Finalize(); return 1; } use_double = double_flag ? 1 : 0; int dim = (int)pow(2, n); if (use_double) { if (rank == 0) { printf(&#34;Using double precision for matrix multiplication.\n&#34;); } if (!mpi_double(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } else { if (rank == 0) { printf(&#34;Using float precision for matrix multiplication.\n&#34;); } if (!mpi_float(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } if (rank == 0) { printf(&#34;Average Gflops: %.3f, Max Gflops: %.3f\n&#34;, ave_gflops, max_gflops); printf(&#34;Average Time: %.6fs, Min Time: %.6fs\n&#34;, ave_time, min_time); } MPI_Finalize(); return 0; } 为了确保合并之后的矩阵没有错误，主程序中增加了随机坐标校验机制。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-06-25T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-26T15:23:01+08:00">
    <meta property="article:tag" content="C&#43;&#43;">
    <meta property="article:tag" content="Fortran">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="矩阵乘法运算(三)-使用MPI并行加速">
  <meta name="twitter:description" content="MPI是一种并行计算协议，也是目前高性能计算集群最为常用的接口程序。MPI通过进程间消息进行通讯，可以跨节点调用多核心执行并行计算，这是OpenMP所不具备的。不同平台均有mpi实现，比如Windows下的MS-MPI和Intel MPI，Linux下的OpenMPI和MPICH等。
1. MPI并行加速循环计算 1.1 C实现 mpi需要对主程序接口进行初始化，建立消息广播机制；同时将需要计算的数组进行分割，广播到不同的进程中。以往这些操作都是openmp或其他并行库内部实现的，程序员不需要关心底层如何实现。但使用mpi需要程序员对每个进程的全局和局部空间进行手动分配，需要控制每个消息的广播，无疑增加了额外的学习成本。
这里将main.c文件修改如下。
#include &#34;mpi.h&#34; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;time.h&gt; #include &lt;math.h&gt; #define MAX(a, b) ((a) &gt; (b) ? (a) : (b)) #define MIN(a, b) ((a) &lt; (b) ? (a) : (b)) extern void matrix_multiply_float(int n, int rank, int size, float local_A[], float B[], float local_C[]); extern void matrix_multiply_double(int n, int rank, int size, double local_A[], double B[], double local_C[]); // Initialize matrix void initialize_matrix_float(int n, float matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (float)(RAND_MAX); } } } void initialize_matrix_double(int n, double matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i &lt; n; i&#43;&#43;) { for (int j = 0; j &lt; n; j&#43;&#43;) { matrix[i * n &#43; j] = rand() / (double)(RAND_MAX); } } } // Execute matrix multiply and print results int mpi_float(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile float *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; float check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (float *)malloc(dim * dim * sizeof(float)); b = (float *)malloc(dim * dim * sizeof(float)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_float(dim, a); initialize_matrix_float(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 float *local_A = (float *)malloc(rows_per_process * dim * sizeof(float)); local_c = (float *)calloc(rows_per_process * dim, sizeof(float)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_FLOAT, local_A, rows_per_process * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B float *full_B = (float *)malloc(dim * dim * sizeof(float)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(float)); } MPI_Bcast(full_B, dim * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_float(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 float *c = NULL; if (rank == 0) { c = (float *)malloc(dim * dim * sizeof(float)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_FLOAT, c, sendcounts, displs, MPI_FLOAT, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; float result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int mpi_double(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); MPI_Comm_size(MPI_COMM_WORLD, &amp;size); // Use volatile to prevent compiler optimizations volatile double *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank &lt; remainder) { rows_per_process&#43;&#43;; } for (int i = 0; i &lt; loop_num; i&#43;&#43;) { int check_indices[2]; double check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (double *)malloc(dim * dim * sizeof(double)); b = (double *)malloc(dim * dim * sizeof(double)); if (a == NULL || b == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } initialize_matrix_double(dim, a); initialize_matrix_double(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k &lt; dim; k&#43;&#43;) { check_value &#43;= a[check_row * dim &#43; k] * b[k * dim &#43; check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(&amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 double *local_A = (double *)malloc(rows_per_process * dim * sizeof(double)); local_c = (double *)calloc(rows_per_process * dim, sizeof(double)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, &#34;Memory allocation failed\n&#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p &lt; size; p&#43;&#43;) { sendcounts[p] = (p &lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset &#43;= sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_DOUBLE, local_A, rows_per_process * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B double *full_B = (double *)malloc(dim * dim * sizeof(double)); if (full_B == NULL) { fprintf(stderr, &#34;Memory allocation failed for full_B\n&#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(double)); } MPI_Bcast(full_B, dim * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); timespec_get(&amp;start_ns, TIME_UTC); matrix_multiply_double(dim, rank, size, local_A, full_B, local_c); timespec_get(&amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) &#43; (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(&amp;cpu_time, &amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(&amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(&#34;%d\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\n&#34;, i &#43; 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 double *c = NULL; if (rank == 0) { c = (double *)malloc(dim * dim * sizeof(double)); if (c == NULL) { fprintf(stderr, &#34;Memory allocation failed for c matrix\n&#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_DOUBLE, c, sendcounts, displs, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; double result_value = c[check_row * dim &#43; check_col]; if (fabs(result_value - check_value) &gt; 0.000001) { fprintf(stderr, &#34;Verification failed at iteration %d: expected %.6f, got %.6f\n&#34;, i &#43; 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops &#43;= gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time &#43;= cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int main(int argc, char *argv[]) { int rank; MPI_Init(&amp;argc, &amp;argv); MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank); int n = 10; // Default matrix size exponent int loop_num = 5; // Number of iterations for averaging double ave_gflops = 0.0, max_gflops = 0.0; // Average and maximum Gflops double ave_time = 0.0, min_time = 1e9; // Average and minimum time int use_double = 0; // Default to float precision // Help message if (argc == 1 || (argc == 2 &amp;&amp; (strcmp(argv[1], &#34;-h&#34;) == 0 || strcmp(argv[1], &#34;--help&#34;) == 0))) { if (rank == 0) { printf(&#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]\n&#34;, argv[0]); printf(&#34; -n SIZE Specify matrix size, like 2^SIZE (default: 10)\n&#34;); printf(&#34; -l LOOP_NUM Specify number of iterations (default: 5)\n&#34;); printf(&#34; -float Use float precision (default)\n&#34;); printf(&#34; -double Use double precision\n&#34;); printf(&#34; -h, --help Show this help message\n&#34;); } MPI_Finalize(); return 0; } // Parse -n, -l, -float, -double options int double_flag = 0, float_flag = 0; for (int argi = 1; argi &lt; argc; &#43;&#43;argi) { if (strcmp(argv[argi], &#34;-n&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { n = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-l&#34;) == 0 &amp;&amp; argi &#43; 1 &lt; argc) { loop_num = atoi(argv[argi &#43; 1]); argi&#43;&#43;; } else if (strcmp(argv[argi], &#34;-double&#34;) == 0) { double_flag = 1; } else if (strcmp(argv[argi], &#34;-float&#34;) == 0) { float_flag = 1; } } if (double_flag &amp;&amp; float_flag) { if (rank == 0) { fprintf(stderr, &#34;Error: Cannot specify both -double and -float options.\n&#34;); } MPI_Finalize(); return 1; } use_double = double_flag ? 1 : 0; int dim = (int)pow(2, n); if (use_double) { if (rank == 0) { printf(&#34;Using double precision for matrix multiplication.\n&#34;); } if (!mpi_double(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } else { if (rank == 0) { printf(&#34;Using float precision for matrix multiplication.\n&#34;); } if (!mpi_float(dim, loop_num, &amp;ave_gflops, &amp;max_gflops, &amp;ave_time, &amp;min_time)) { MPI_Finalize(); return 1; } } if (rank == 0) { printf(&#34;Average Gflops: %.3f, Max Gflops: %.3f\n&#34;, ave_gflops, max_gflops); printf(&#34;Average Time: %.6fs, Min Time: %.6fs\n&#34;, ave_time, min_time); } MPI_Finalize(); return 0; } 为了确保合并之后的矩阵没有错误，主程序中增加了随机坐标校验机制。">


<link rel="canonical" href="https://andrewmoa.site/zh-cn/post/2025-06-25-matrix_multiplication-3/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.min.8f52268ce38691bd84eeee05121a11e2bc53c0e9f7fa97e2b147af29c8a627e1.css">





      <script async src="https://www.googletagmanager.com/gtag/js?id=G-75W5D7R0V1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-75W5D7R0V1');
        }
      </script>




  
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Andrew Moa"},"dateModified":"2025-06-26T15:23:01+08:00","datePublished":"2025-06-25T00:00:00Z","description":"MPI是一种并行计算协议，也是目前高性能计算集群最为常用的接口程序。MPI通过进程间消息进行通讯，可以跨节点调用多核心执行并行计算，这是OpenMP所不具备的。不同平台均有mpi实现，比如Windows下的MS-MPI和Intel MPI，Linux下的OpenMPI和MPICH等。\n1. MPI并行加速循环计算 1.1 C实现 mpi需要对主程序接口进行初始化，建立消息广播机制；同时将需要计算的数组进行分割，广播到不同的进程中。以往这些操作都是openmp或其他并行库内部实现的，程序员不需要关心底层如何实现。但使用mpi需要程序员对每个进程的全局和局部空间进行手动分配，需要控制每个消息的广播，无疑增加了额外的学习成本。\n这里将main.c文件修改如下。\n#include \u0026#34;mpi.h\u0026#34; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;math.h\u0026gt; #define MAX(a, b) ((a) \u0026gt; (b) ? (a) : (b)) #define MIN(a, b) ((a) \u0026lt; (b) ? (a) : (b)) extern void matrix_multiply_float(int n, int rank, int size, float local_A[], float B[], float local_C[]); extern void matrix_multiply_double(int n, int rank, int size, double local_A[], double B[], double local_C[]); // Initialize matrix void initialize_matrix_float(int n, float matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i \u0026lt; n; i++) { for (int j = 0; j \u0026lt; n; j++) { matrix[i * n + j] = rand() / (float)(RAND_MAX); } } } void initialize_matrix_double(int n, double matrix[]) { srand((unsigned)time(NULL)); for (int i = 0; i \u0026lt; n; i++) { for (int j = 0; j \u0026lt; n; j++) { matrix[i * n + j] = rand() / (double)(RAND_MAX); } } } // Execute matrix multiply and print results int mpi_float(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;rank); MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;size); // Use volatile to prevent compiler optimizations volatile float *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank \u0026lt; remainder) { rows_per_process++; } for (int i = 0; i \u0026lt; loop_num; i++) { int check_indices[2]; float check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (float *)malloc(dim * dim * sizeof(float)); b = (float *)malloc(dim * dim * sizeof(float)); if (a == NULL || b == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed\\n\u0026#34;); return 0; } initialize_matrix_float(dim, a); initialize_matrix_float(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k \u0026lt; dim; k++) { check_value += a[check_row * dim + k] * b[k * dim + check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(\u0026amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(\u0026amp;check_value, 1, MPI_FLOAT, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 float *local_A = (float *)malloc(rows_per_process * dim * sizeof(float)); local_c = (float *)calloc(rows_per_process * dim, sizeof(float)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed\\n\u0026#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p \u0026lt; size; p++) { sendcounts[p] = (p \u0026lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset += sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_FLOAT, local_A, rows_per_process * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B float *full_B = (float *)malloc(dim * dim * sizeof(float)); if (full_B == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed for full_B\\n\u0026#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(float)); } MPI_Bcast(full_B, dim * dim, MPI_FLOAT, 0, MPI_COMM_WORLD); timespec_get(\u0026amp;start_ns, TIME_UTC); matrix_multiply_float(dim, rank, size, local_A, full_B, local_c); timespec_get(\u0026amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) + (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(\u0026amp;cpu_time, \u0026amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(\u0026amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(\u0026#34;%d\\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\\n\u0026#34;, i + 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 float *c = NULL; if (rank == 0) { c = (float *)malloc(dim * dim * sizeof(float)); if (c == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed for c matrix\\n\u0026#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_FLOAT, c, sendcounts, displs, MPI_FLOAT, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; float result_value = c[check_row * dim + check_col]; if (fabs(result_value - check_value) \u0026gt; 0.001) { fprintf(stderr, \u0026#34;Verification failed at iteration %d: expected %.6f, got %.6f\\n\u0026#34;, i + 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops += gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time += cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int mpi_double(int dim, int loop_num, double *ave_gflops, double *max_gflops, double *ave_time, double *min_time) { int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;rank); MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;size); // Use volatile to prevent compiler optimizations volatile double *a, *b, *local_c; struct timespec start_ns, end_ns; double cpu_time, total_cpu_time; // 计算每个进程处理的行数 int rows_per_process = dim / size; int remainder = dim % size; if (rank \u0026lt; remainder) { rows_per_process++; } for (int i = 0; i \u0026lt; loop_num; i++) { int check_indices[2]; double check_value; // 主进程分配完整矩阵内存 if (rank == 0) { a = (double *)malloc(dim * dim * sizeof(double)); b = (double *)malloc(dim * dim * sizeof(double)); if (a == NULL || b == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed\\n\u0026#34;); return 0; } initialize_matrix_double(dim, a); initialize_matrix_double(dim, b); // 生成校验值 int check_row = rand() % dim; int check_col = rand() % dim; check_value = 0.0; for (int k = 0; k \u0026lt; dim; k++) { check_value += a[check_row * dim + k] * b[k * dim + check_col]; } check_indices[0] = check_row; check_indices[1] = check_col; // 广播校验行列索引和校验值 MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(\u0026amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } else { a = NULL; b = NULL; MPI_Bcast(check_indices, 2, MPI_INT, 0, MPI_COMM_WORLD); MPI_Bcast(\u0026amp;check_value, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); } // 为每个进程分配局部矩阵空间 double *local_A = (double *)malloc(rows_per_process * dim * sizeof(double)); local_c = (double *)calloc(rows_per_process * dim, sizeof(double)); if (local_A == NULL || local_c == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed\\n\u0026#34;); return 0; } // 分发矩阵 A 的行到各个进程 int *sendcounts = (int *)malloc(size * sizeof(int)); int *displs = (int *)malloc(size * sizeof(int)); int offset = 0; for (int p = 0; p \u0026lt; size; p++) { sendcounts[p] = (p \u0026lt; remainder) ? (rows_per_process * dim) : ((rows_per_process - 1) * dim); displs[p] = offset; offset += sendcounts[p]; } MPI_Scatterv(a, sendcounts, displs, MPI_DOUBLE, local_A, rows_per_process * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 所有进程都需要完整的矩阵 B double *full_B = (double *)malloc(dim * dim * sizeof(double)); if (full_B == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed for full_B\\n\u0026#34;); return 0; } if (rank == 0) { memcpy(full_B, b, dim * dim * sizeof(double)); } MPI_Bcast(full_B, dim * dim, MPI_DOUBLE, 0, MPI_COMM_WORLD); timespec_get(\u0026amp;start_ns, TIME_UTC); matrix_multiply_double(dim, rank, size, local_A, full_B, local_c); timespec_get(\u0026amp;end_ns, TIME_UTC); cpu_time = (end_ns.tv_sec - start_ns.tv_sec) + (end_ns.tv_nsec - start_ns.tv_nsec) / 1e9; // 使用 MPI_Reduce 对所有进程的 cpu_time 求和 MPI_Reduce(\u0026amp;cpu_time, \u0026amp;total_cpu_time, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD); if (rank == 0) { // 计算平均值 cpu_time = total_cpu_time / size; } // 将平均值广播给所有进程 MPI_Bcast(\u0026amp;cpu_time, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD); double gflops = 1e-9 * dim * dim * dim * 2 / cpu_time; if (rank == 0) { printf(\u0026#34;%d\\t: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)\\n\u0026#34;, i + 1, dim, dim, cpu_time, gflops); fflush(stdout); // 强制刷新标准输出缓冲区 } // 收集所有进程的局部结果到主进程 double *c = NULL; if (rank == 0) { c = (double *)malloc(dim * dim * sizeof(double)); if (c == NULL) { fprintf(stderr, \u0026#34;Memory allocation failed for c matrix\\n\u0026#34;); return 0; } } MPI_Gatherv(local_c, rows_per_process * dim, MPI_DOUBLE, c, sendcounts, displs, MPI_DOUBLE, 0, MPI_COMM_WORLD); // 主进程进行校验 if (rank == 0) { int check_row = check_indices[0]; int check_col = check_indices[1]; double result_value = c[check_row * dim + check_col]; if (fabs(result_value - check_value) \u0026gt; 0.000001) { fprintf(stderr, \u0026#34;Verification failed at iteration %d: expected %.6f, got %.6f\\n\u0026#34;, i + 1, check_value, result_value); } free(c); } // Free memory if (rank == 0) { free(a); free(b); } free(local_A); free(local_c); free(sendcounts); free(displs); free(full_B); *ave_gflops += gflops; *max_gflops = MAX(*max_gflops, gflops); *ave_time += cpu_time; *min_time = MIN(*min_time, cpu_time); } *ave_gflops /= loop_num; *ave_time /= loop_num; return 1; } int main(int argc, char *argv[]) { int rank; MPI_Init(\u0026amp;argc, \u0026amp;argv); MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;rank); int n = 10; // Default matrix size exponent int loop_num = 5; // Number of iterations for averaging double ave_gflops = 0.0, max_gflops = 0.0; // Average and maximum Gflops double ave_time = 0.0, min_time = 1e9; // Average and minimum time int use_double = 0; // Default to float precision // Help message if (argc == 1 || (argc == 2 \u0026amp;\u0026amp; (strcmp(argv[1], \u0026#34;-h\u0026#34;) == 0 || strcmp(argv[1], \u0026#34;--help\u0026#34;) == 0))) { if (rank == 0) { printf(\u0026#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]\\n\u0026#34;, argv[0]); printf(\u0026#34; -n SIZE Specify matrix size, like 2^SIZE (default: 10)\\n\u0026#34;); printf(\u0026#34; -l LOOP_NUM Specify number of iterations (default: 5)\\n\u0026#34;); printf(\u0026#34; -float Use float precision (default)\\n\u0026#34;); printf(\u0026#34; -double Use double precision\\n\u0026#34;); printf(\u0026#34; -h, --help Show this help message\\n\u0026#34;); } MPI_Finalize(); return 0; } // Parse -n, -l, -float, -double options int double_flag = 0, float_flag = 0; for (int argi = 1; argi \u0026lt; argc; ++argi) { if (strcmp(argv[argi], \u0026#34;-n\u0026#34;) == 0 \u0026amp;\u0026amp; argi + 1 \u0026lt; argc) { n = atoi(argv[argi + 1]); argi++; } else if (strcmp(argv[argi], \u0026#34;-l\u0026#34;) == 0 \u0026amp;\u0026amp; argi + 1 \u0026lt; argc) { loop_num = atoi(argv[argi + 1]); argi++; } else if (strcmp(argv[argi], \u0026#34;-double\u0026#34;) == 0) { double_flag = 1; } else if (strcmp(argv[argi], \u0026#34;-float\u0026#34;) == 0) { float_flag = 1; } } if (double_flag \u0026amp;\u0026amp; float_flag) { if (rank == 0) { fprintf(stderr, \u0026#34;Error: Cannot specify both -double and -float options.\\n\u0026#34;); } MPI_Finalize(); return 1; } use_double = double_flag ? 1 : 0; int dim = (int)pow(2, n); if (use_double) { if (rank == 0) { printf(\u0026#34;Using double precision for matrix multiplication.\\n\u0026#34;); } if (!mpi_double(dim, loop_num, \u0026amp;ave_gflops, \u0026amp;max_gflops, \u0026amp;ave_time, \u0026amp;min_time)) { MPI_Finalize(); return 1; } } else { if (rank == 0) { printf(\u0026#34;Using float precision for matrix multiplication.\\n\u0026#34;); } if (!mpi_float(dim, loop_num, \u0026amp;ave_gflops, \u0026amp;max_gflops, \u0026amp;ave_time, \u0026amp;min_time)) { MPI_Finalize(); return 1; } } if (rank == 0) { printf(\u0026#34;Average Gflops: %.3f, Max Gflops: %.3f\\n\u0026#34;, ave_gflops, max_gflops); printf(\u0026#34;Average Time: %.6fs, Min Time: %.6fs\\n\u0026#34;, ave_time, min_time); } MPI_Finalize(); return 0; } 为了确保合并之后的矩阵没有错误，主程序中增加了随机坐标校验机制。\n","image":"/images/code-bg.jpg","name":"矩阵乘法运算(三)-使用MPI并行加速","url":"https://andrewmoa.site/zh-cn/post/2025-06-25-matrix_multiplication-3/"}
</script>

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/zh-cn/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/logo.svg" alt="logo">
    </a>
  </div>
  
  <h1 class="hidden md:flex flex-col justify-center mx-2">
    <a href="/zh-cn/" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">
      Andrew Moa Blog Site
    </a>
  </h1>
  
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">打开菜单</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-xs md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600"
            href="/zh-cn/post/" title="文章">文章</a>
        </li>
      
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/zh-cn/about/" title="关于">关于</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none">
    <div class="h-full static">
      <button id="navbar-lang-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
        <span class="sr-only">打开语言切换</span>
        <i class="w-8 h-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c0 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>

        </i>
      </button>
      <div class="absolute hidden top-16 z-50" id="navbar-lang">
        <ul class="flex flex-col rounded-xs px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
          <li class="">
            <a class="block px-3 py-3 hover:text-emerald-600"
              href="/post/2025-06-25-matrix_multiplication-3/" title="English">English</a></li>
        
          <li class="">
            <span class="block px-3 py-3 cursor-default hover:text-emerald-600">中文</span>
            </li>
        
        </ul>
      </div>
    </div>
  </div>
  
  <div class="flex-none md:hidden">
    <a href=/zh-cn/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">搜索</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="relative flex items-center gap-1 px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="切换夜间模式">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="切换夜间模式">
      <div class="absolute z-10 w-15 h-8 rounded-full bg-white dark:bg-gray-700"></div>
      <i class="h-6 w-6 z-20 ml-1 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:invisible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

      </i>
      <i class="h-6 w-6 z-20 mr-1 flex-none rounded-full place-self-center invisible peer-checked:visible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

      </i>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div id="progress" class="fixed top-0 left-0 w-full h-1 bg-blue-500"></div>
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/zh-cn/post/2025-06-25-matrix_multiplication-3/">
        <figure>
    <img class="w-full object-cover h-36 md:h-48 xl:h-60" src="/images/code-bg.jpg"
      alt="矩阵乘法运算(三)-使用MPI并行加速" title="矩阵乘法运算(三)-使用MPI并行加速"
      loading="lazy"
    >
  </figure>
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/zh-cn/post/2025-06-25-matrix_multiplication-3/">矩阵乘法运算(三)-使用MPI并行加速</a>
      </h1>

      
      
  <ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300">
    
      
      <li>
        <a href="/zh-cn/categories/code/"
          class="text-sm mr-2 px-2 py-1 rounded-sm border border-emerald-800 bg-emerald-800 text-slate-50">
          Code
        </a>
      </li>
      
    
    
      
      <li>
        <a href="/zh-cn/tags/c&#43;&#43;/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">C&#43;&#43;</span>
        </a>
      </li>
      
      <li>
        <a href="/zh-cn/tags/fortran/"
          class="flex flex-row text-sm mr-2 py-1">
          <i class="h-5 w-5 flex-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M5 9l14 0"></path>
   <path d="M5 15l14 0"></path>
   <path d="M11 4l-4 16"></path>
   <path d="M17 4l-4 16"></path>
</svg>

          </i>
          <span class="ml-0">Fortran</span>
        </a>
      </li>
      
    
  </ul>



      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  
  
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
   <path d="M16 3v4"></path>
   <path d="M8 3v4"></path>
   <path d="M4 11h16"></path>
   <path d="M11 15h1"></path>
   <path d="M12 15v3"></path>
</svg>

    </i>
    <time datetime="2025-06-25T00:00:00&#43;00:00">
      2025-06-25
    </time>
  </div>

  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      阅读时长26分钟
    </span>
  </div>
</div>

      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
    class="icon icon-tabler icons-tabler-outline icon-tabler-user">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>

    </i>
    <span>Andrew Moa</span>
  </div>
</div>

      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>目录</h2>
          <aside><nav id="TableOfContents">
  <ul>
    <li><a href="#1-mpi并行加速循环计算">1. MPI并行加速循环计算</a>
      <ul>
        <li><a href="#11-c实现">1.1 C实现</a></li>
        <li><a href="#12-fortran实现">1.2 fortran实现</a></li>
      </ul>
    </li>
    <li><a href="#2-mpi加速分块矩阵运算">2. MPI加速分块矩阵运算</a>
      <ul>
        <li><a href="#21-c实现">2.1 C实现</a></li>
        <li><a href="#22-fortran实现">2.2 fortran实现</a></li>
      </ul>
    </li>
    <li><a href="#3-mpi并行配合底层优化加速">3. MPI并行配合底层优化加速</a>
      <ul>
        <li><a href="#31-fortran编译器优化">3.1 fortran编译器优化</a></li>
        <li><a href="#32-blas加速">3.2 BLAS加速</a></li>
      </ul>
    </li>
    <li><a href="#4-总结">4. 总结</a></li>
  </ul>
</nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <p>MPI是一种并行计算协议，也是目前高性能计算集群最为常用的接口程序。MPI通过进程间消息进行通讯，可以跨节点调用多核心执行并行计算，这是OpenMP所不具备的。不同平台均有mpi实现，比如Windows下的MS-MPI和Intel MPI，Linux下的OpenMPI和MPICH等。</p>
<h2 id="1-mpi并行加速循环计算">1. MPI并行加速循环计算</h2>
<h3 id="11-c实现">1.1 C实现</h3>
<p>mpi需要对主程序接口进行初始化，建立消息广播机制；同时将需要计算的数组进行分割，广播到不同的进程中。以往这些操作都是openmp或其他并行库内部实现的，程序员不需要关心底层如何实现。但使用mpi需要程序员对每个进程的全局和局部空间进行手动分配，需要控制每个消息的广播，无疑增加了额外的学习成本。</p>
<p>这里将<code>main.c</code>文件修改如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;mpi.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX(a, b) ((a) &gt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MIN(a, b) ((a) &lt; (b) ? (a) : (b))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Initialize matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">float</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">matrix</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">srand</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">RAND_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Execute matrix multiply and print results
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">mpi_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">volatile</span> <span class="kt">float</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">local_c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">total_cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">check_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 主进程分配完整矩阵内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 生成校验值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">check_value</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_col</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 广播校验行列索引和校验值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 为每个进程分配局部矩阵空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">local_A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_A</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">local_c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 分发矩阵 A 的行到各个进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="o">*</span><span class="n">sendcounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="o">*</span><span class="n">displs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">rows_per_process</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">displs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Scatterv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 所有进程都需要完整的矩阵 B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">full_B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">full_B</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for full_B</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">full_B</span><span class="p">,</span> <span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用 MPI_Reduce 对所有进程的 cpu_time 求和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 计算平均值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">total_cpu_time</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 将平均值广播给所有进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span> <span class="c1">// 强制刷新标准输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 收集所有进程的局部结果到主进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">float</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for c matrix</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Gatherv</span><span class="p">(</span><span class="n">local_c</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 主进程进行校验
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">float</span> <span class="n">result_value</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">fabs</span><span class="p">(</span><span class="n">result_value</span> <span class="o">-</span> <span class="n">check_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Verification failed at iteration %d: expected %.6f, got %.6f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">check_value</span><span class="p">,</span> <span class="n">result_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Free memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">sendcounts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">displs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">full_B</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">mpi_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_num</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">ave_time</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">min_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use volatile to prevent compiler optimizations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">volatile</span> <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">local_c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_ns</span><span class="p">,</span> <span class="n">end_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">total_cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">check_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 主进程分配完整矩阵内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">initialize_matrix_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 生成校验值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">dim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">check_value</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_col</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 广播校验行列索引和校验值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">check_indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 为每个进程分配局部矩阵空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">local_A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_A</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">local_c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 分发矩阵 A 的行到各个进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="o">*</span><span class="n">sendcounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="o">*</span><span class="n">displs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">rows_per_process</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">displs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sendcounts</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Scatterv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 所有进程都需要完整的矩阵 B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">full_B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">full_B</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for full_B</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">memcpy</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="n">full_B</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">full_B</span><span class="p">,</span> <span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">timespec_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_ns</span><span class="p">,</span> <span class="n">TIME_UTC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_ns</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_ns</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用 MPI_Reduce 对所有进程的 cpu_time 求和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 计算平均值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">total_cpu_time</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 将平均值广播给所有进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">gflops</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">: %d x %d Matrix multiply wall time : %.6fs(%.3fGflops)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span> <span class="c1">// 强制刷新标准输出缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 收集所有进程的局部结果到主进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Memory allocation failed for c matrix</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Gatherv</span><span class="p">(</span><span class="n">local_c</span><span class="p">,</span> <span class="n">rows_per_process</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">sendcounts</span><span class="p">,</span> <span class="n">displs</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 主进程进行校验
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_row</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">check_col</span> <span class="o">=</span> <span class="n">check_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">result_value</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">check_row</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">check_col</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">fabs</span><span class="p">(</span><span class="n">result_value</span> <span class="o">-</span> <span class="n">check_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.000001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Verification failed at iteration %d: expected %.6f, got %.6f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">check_value</span><span class="p">,</span> <span class="n">result_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Free memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">local_c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">sendcounts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">displs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">full_B</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">+=</span> <span class="n">gflops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">max_gflops</span> <span class="o">=</span> <span class="nf">MAX</span><span class="p">(</span><span class="o">*</span><span class="n">max_gflops</span><span class="p">,</span> <span class="n">gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">ave_time</span> <span class="o">+=</span> <span class="n">cpu_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">min_time</span> <span class="o">=</span> <span class="nf">MIN</span><span class="p">(</span><span class="o">*</span><span class="n">min_time</span><span class="p">,</span> <span class="n">cpu_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_gflops</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ave_time</span> <span class="o">/=</span> <span class="n">loop_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>                                <span class="c1">// Default matrix size exponent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">loop_num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>                          <span class="c1">// Number of iterations for averaging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">ave_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">max_gflops</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// Average and maximum Gflops
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">ave_time</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">;</span>     <span class="c1">// Average and minimum time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">use_double</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                        <span class="c1">// Default to float precision
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Help message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-h&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--help&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: mpiexec/mpirun [-n/-np $NUM_PROCS] %s [-n SIZE] [-l LOOP_NUM] [-float|-double]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -n SIZE      Specify matrix size, like 2^SIZE (default: 10)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -l LOOP_NUM  Specify number of iterations (default: 5)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -float       Use float precision (default)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -double      Use double precision</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;  -h, --help   Show this help message</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Parse -n, -l, -float, -double options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">double_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">float_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">argi</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">argi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-n&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">n</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-l&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop_num</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">argi</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-double&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">double_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argi</span><span class="p">],</span> <span class="s">&#34;-float&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">float_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">double_flag</span> <span class="o">&amp;&amp;</span> <span class="n">float_flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error: Cannot specify both -double and -float options.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">use_double</span> <span class="o">=</span> <span class="n">double_flag</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nf">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">use_double</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using double precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">mpi_double</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Using float precision for matrix multiplication.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">mpi_float</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">loop_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_gflops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ave_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Gflops: %.3f, Max Gflops: %.3f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_gflops</span><span class="p">,</span> <span class="n">max_gflops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Average Time: %.6fs, Min Time: %.6fs</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ave_time</span><span class="p">,</span> <span class="n">min_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">MPI_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>为了确保合并之后的矩阵没有错误，主程序中增加了随机坐标校验机制。</p>
<p><code>mpi.c</code>是循环嵌套矩阵运算的具体实现。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 矩阵乘法运算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 矩阵乘法运算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>CMakeLists.txt</code>包含mpi头文件，这里编译用的是Windows平台，对应mpi库为ms-mpi。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">mpi</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">CXX</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">20</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi.c</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>在Windows平台上使用MSYS2的ucrt64编译，输出Release程序执行效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235279s</span><span class="p">(</span><span class="mf">9</span><span class="p">.</span><span class="n">127Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">245679s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">741Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">252880s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">492Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">253803s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">461Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235253s</span><span class="p">(</span><span class="mf">9</span><span class="p">.</span><span class="n">128Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">261678s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">207Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">261258s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">220Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">256560s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">370Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">254379s</span><span class="p">(</span><span class="mf">8</span><span class="p">.</span><span class="n">442Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">271509s</span><span class="p">(</span><span class="mf">7</span><span class="p">.</span><span class="n">909Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">8.510</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">9.128</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">252828s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">235253s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">317128s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">772Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">316111s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">793Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">320794s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">694Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">334887s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">413Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">328439s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">538Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">326553s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">576Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">321168s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">686Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">322008s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">669Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">330364s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">500Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314038s</span><span class="p">(</span><span class="mf">6</span><span class="p">.</span><span class="n">838Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.648</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">6.838</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">323149s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">314038s</span>
</span></span></code></pre></div><p>计算机器CPU为AMD AI 9 365w，10核心20线程，这里使用了超线程，整体性能和openmp其实差不多。可以通过命令行控制计算进程数量。由于每个进程都需要分配局部存储空间，计算进程越多内存开销越大。</p>
<h3 id="12-fortran实现">1.2 fortran实现</h3>
<p>fortran也提供了mpi实现，ms-mpi和openmpi都提供了fortran的接口。限于篇幅，这里主程序源码还是采用和上一节相同的<code>main.c</code>，矩阵乘法部分通过fortran实现，通过fortran和C混合编程的方式实现程序功能。</p>
<p>矩阵乘法计算相关函数在fortran源文件<code>mpi2c.f90</code>里定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_float&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将一维数组转换为二维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 初始化结果矩阵
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将二维数组转换为一维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_double&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将一维数组转换为二维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 初始化结果矩阵
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将二维数组转换为一维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>由于C程序接口将二维矩阵存储在一维数组里，为了使fortran程序能正常读取存储在一维数组里的矩阵信息，需要定义一维数组到二维数组的转换，开辟新的存储空间。为了方便接口复用，这里把数组转换的相关内容定义到了计算函数中，会带来额外的性能开销。</p>
<p><code>CMakeLists.txt</code>没太大区别，包含C的mpi头文件，激活了fortran语言支持。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">mpi-fortran</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">Fortran</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_Fortran_STANDARD</span> <span class="s">2008</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_Fortran_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi2c.f90</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>在Windows下使用MSYS2的ucrt64工具链编译，Release程序运行效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">mpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">mpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">mpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078928s</span><span class="p">(</span><span class="mf">27</span><span class="p">.</span><span class="n">208Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">089289s</span><span class="p">(</span><span class="mf">24</span><span class="p">.</span><span class="n">051Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082848s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">921Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">080060s</span><span class="p">(</span><span class="mf">26</span><span class="p">.</span><span class="n">823Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">084739s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">342Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083975s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">573Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">085056s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">248Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083494s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">720Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082314s</span><span class="p">(</span><span class="mf">26</span><span class="p">.</span><span class="n">089Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">082700s</span><span class="p">(</span><span class="mf">25</span><span class="p">.</span><span class="n">967Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">25.794</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">27.208</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">083340s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078928s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">mpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">mpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">mpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126719s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">947Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127700s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">817Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126309s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">002Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">124125s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">301Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">121543s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">668Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">129106s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">634Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">129957s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">525Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">128702s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">686Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">127478s</span><span class="p">(</span><span class="mf">16</span><span class="p">.</span><span class="n">846Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">125188s</span><span class="p">(</span><span class="mf">17</span><span class="p">.</span><span class="n">154Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">16.958</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">17.668</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">126683s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">121543s</span>
</span></span></code></pre></div><p>以上是在和1.1相同的处理器上运行的结果，fortran数组采用了和C不同的列优先存储方式，缓存命中率提高，有利于提高矩阵运算性能。</p>
<h2 id="2-mpi加速分块矩阵运算">2. MPI加速分块矩阵运算</h2>
<h3 id="21-c实现">2.1 C实现</h3>
<p>上面的结果揭示了缓存性能对矩阵运算存在较大的影响，为了提高缓存命中率，这里尝试使用分块矩阵，看是否能提升C语言程序的计算性能。</p>
<p>主程序<code>main.c</code>和前面一样保持不变，这里只改动<code>mpi.c</code>，在原来的循环嵌套计算的基础上增加分块计算功能：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 分块大小，可根据缓存大小调整
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BLOCK_SIZE 8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化 local_C 为 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分块矩阵乘法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bi</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">bi</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bj</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bj</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bk</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bk</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 块内计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">end_i</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bi</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">rows_per_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_j</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bj</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_k</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bk</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end_j</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">bk</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">end_k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sum</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Parallel matrix multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化 local_C 为 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分块矩阵乘法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bi</span> <span class="o">&lt;</span> <span class="n">rows_per_process</span><span class="p">;</span> <span class="n">bi</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bj</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bj</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bk</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">bk</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 块内计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">end_i</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bi</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">rows_per_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_j</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bj</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">end_k</span> <span class="o">=</span> <span class="nf">fmin</span><span class="p">(</span><span class="n">bk</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bj</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end_j</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">bk</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">end_k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">sum</span> <span class="o">+=</span> <span class="n">local_A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">local_C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>CMakeLists.txt</code>文件和1.1中的相同。</p>
<p>在Windows下使用MSYS2的ucrt64工具链编译，程序执行效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">blockmpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">blockmpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">blockmpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>        
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039390s</span><span class="p">(</span><span class="mf">54</span><span class="p">.</span><span class="n">519Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041973s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">164Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044693s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">050Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042822s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">149Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044406s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">361Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041931s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">215Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042498s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">531Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041639s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">573Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042505s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">523Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043471s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">401Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">50.548</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">54.519</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042533s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">039390s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="n">blockmpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="n">blockmpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="n">blockmpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041856s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">307Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">045559s</span><span class="p">(</span><span class="mf">47</span><span class="p">.</span><span class="n">136Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">044370s</span><span class="p">(</span><span class="mf">48</span><span class="p">.</span><span class="n">400Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043212s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">697Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041711s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">485Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">043633s</span><span class="p">(</span><span class="mf">49</span><span class="p">.</span><span class="n">217Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042332s</span><span class="p">(</span><span class="mf">50</span><span class="p">.</span><span class="n">730Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041305s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">991Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">041940s</span><span class="p">(</span><span class="mf">51</span><span class="p">.</span><span class="n">203Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">040975s</span><span class="p">(</span><span class="mf">52</span><span class="p">.</span><span class="n">410Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">50.358</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">52.410</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">042689s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">040975s</span>
</span></span></code></pre></div><p>这里分块大小设置为8，是根据大量测试得出的最优结果。在其他平台上实施，需要针对该平台硬件进行测试，才能确定最合适的分块大小。</p>
<h3 id="22-fortran实现">2.2 fortran实现</h3>
<p>接下来用fortran实现分块矩阵mpi加速功能，看看性能是否有提升。</p>
<p><code>main.c</code>和<code>CMakeLists.txt</code>基本和1.2相同，只改动<code>mpi2c.f90</code>文件，增加分块内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fortran" data-lang="fortran"><span class="line"><span class="cl"><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_float&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_float</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="c">! 分块大小，可根据实际情况调整
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将一维数组转换为二维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 初始化结果矩阵
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 分块矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将二维数组转换为一维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">local_A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">local_C</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;matrix_multiply_double&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">iso_c_binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">real</span><span class="p">(</span><span class="k">c_double</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">remainder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">integer</span><span class="p">(</span><span class="k">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">  </span><span class="c">! 分块大小，可根据实际情况调整
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remainder</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">B_2d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将一维数组转换为二维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_A</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">B_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 初始化结果矩阵
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="n">local_C_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_c_double</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 分块矩阵乘法计算
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">local_A_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B_2d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">! 将二维数组转换为一维数组
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rows_per_process</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">local_C</span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">local_A_2d</span><span class="p">,</span><span class="w"> </span><span class="n">B_2d</span><span class="p">,</span><span class="w"> </span><span class="n">local_C_2d</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">matrix_multiply_double</span><span class="w">
</span></span></span></code></pre></div><p>Windows下使用MSYS2的ucrt64工具链编译输出Release程序，执行效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">blockmpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">blockmpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">blockmpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050200s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">779Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050326s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">671Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">049548s</span><span class="p">(</span><span class="mf">43</span><span class="p">.</span><span class="n">341Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">050283s</span><span class="p">(</span><span class="mf">42</span><span class="p">.</span><span class="n">708Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">048627s</span><span class="p">(</span><span class="mf">44</span><span class="p">.</span><span class="n">163Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">052763s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">700Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">056050s</span><span class="p">(</span><span class="mf">38</span><span class="p">.</span><span class="n">314Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">055364s</span><span class="p">(</span><span class="mf">38</span><span class="p">.</span><span class="n">789Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">051921s</span><span class="p">(</span><span class="mf">41</span><span class="p">.</span><span class="n">361Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">053460s</span><span class="p">(</span><span class="mf">40</span><span class="p">.</span><span class="n">170Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">41.500</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">44.163</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">051854s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">048627s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">blockmpi-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">blockmpi-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">blockmpi-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">078406s</span><span class="p">(</span><span class="mf">27</span><span class="p">.</span><span class="n">389Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">066016s</span><span class="p">(</span><span class="mf">32</span><span class="p">.</span><span class="n">530Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">067229s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">943Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">067948s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">605Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063610s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">760Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063506s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">816Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063981s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">564Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063603s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">764Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">068714s</span><span class="p">(</span><span class="mf">31</span><span class="p">.</span><span class="n">252Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">1024</span> <span class="n">x</span> <span class="mf">1024</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063268s</span><span class="p">(</span><span class="mf">33</span><span class="p">.</span><span class="n">943Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">32.357</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">33.943</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">066628s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">063268s</span>
</span></span></code></pre></div><p>看上去比C实现的要慢一点，但实际上fortran计算函数内部增加了数组转换、开辟存储空间等功能增加了额外的运行时间。除去这部分开销，实际计算性能应该会更好一点。</p>
<h2 id="3-mpi并行配合底层优化加速">3. MPI并行配合底层优化加速</h2>
<h3 id="31-fortran编译器优化">3.1 fortran编译器优化</h3>
<p>虽然前面的分块矩阵已经有了很大的提升，但和之前提到的编译器底层优化和专业数学库比起来，这点性能还是有点不够。现在尝试将mpi配合fortran编译器的底层优化，看能否在性能上进一步提升。</p>
<p><code>main.c</code>和<code>CMakeLists.txt</code>基本和1.2相同，这里改动<code>mpi2c.f90</code>文件，使用fortran内置函数matmul实现矩阵运算功能：</p>
<pre tabindex="0"><code class="language-fortan" data-lang="fortan">subroutine matrix_multiply_float(n, rank, size, local_A, B, local_C) bind(C, name=&#34;matrix_multiply_float&#34;)
    use, intrinsic :: iso_c_binding
    implicit none
    integer(c_int), value, intent(in) :: n, rank, size
    real(c_float), intent(in) :: local_A(*)
    real(c_float), intent(in) :: B(*)
    real(c_float), intent(out) :: local_C(*)
    real(c_float), allocatable :: local_A_2d(:, :)
    real(c_float), allocatable :: B_2d(:, :)
    real(c_float), allocatable :: local_C_2d(:, :)
    integer(c_int) :: rows_per_process
    integer(c_int) :: remainder
    integer(c_int) :: i, j

    remainder = mod(n, size)
    rows_per_process = n / size
    if (rank &lt; remainder) then
        rows_per_process = rows_per_process + 1
    end if

    allocate(local_A_2d(rows_per_process, n))
    allocate(B_2d(n, n))
    allocate(local_C_2d(rows_per_process, n))

    ! 将一维数组转换为二维数组
    do i = 1, rows_per_process
        do j = 1, n
            local_A_2d(i, j) = local_A((i - 1) * n + j)
        end do
    end do

    do i = 1, n
        do j = 1, n
            B_2d(i, j) = B((i - 1) * n + j)
        end do
    end do

    ! 使用 matmul 进行矩阵乘法计算
    local_C_2d = matmul(local_A_2d, B_2d)

    ! 将二维数组转换为一维数组
    do i = 1, rows_per_process
        do j = 1, n
            local_C((i - 1) * n + j) = local_C_2d(i, j)
        end do
    end do

    deallocate(local_A_2d, B_2d, local_C_2d)
end subroutine matrix_multiply_float

subroutine matrix_multiply_double(n, rank, size, local_A, B, local_C) bind(C, name=&#34;matrix_multiply_double&#34;)
    use, intrinsic :: iso_c_binding
    implicit none
    integer(c_int), value, intent(in) :: n, rank, size
    real(c_double), intent(in) :: local_A(*)
    real(c_double), intent(in) :: B(*)
    real(c_double), intent(out) :: local_C(*)
    real(c_double), allocatable :: local_A_2d(:, :)
    real(c_double), allocatable :: B_2d(:, :)
    real(c_double), allocatable :: local_C_2d(:, :)
    integer(c_int) :: rows_per_process
    integer(c_int) :: remainder
    integer(c_int) :: i, j

    remainder = mod(n, size)
    rows_per_process = n / size
    if (rank &lt; remainder) then
        rows_per_process = rows_per_process + 1
    end if

    allocate(local_A_2d(rows_per_process, n))
    allocate(B_2d(n, n))
    allocate(local_C_2d(rows_per_process, n))

    ! 将一维数组转换为二维数组
    do i = 1, rows_per_process
        do j = 1, n
            local_A_2d(i, j) = local_A((i - 1) * n + j)
        end do
    end do

    do i = 1, n
        do j = 1, n
            B_2d(i, j) = B((i - 1) * n + j)
        end do
    end do

    ! 使用 matmul 进行矩阵乘法计算
    local_C_2d = matmul(local_A_2d, B_2d)

    ! 将二维数组转换为一维数组
    do i = 1, rows_per_process
        do j = 1, n
            local_C((i - 1) * n + j) = local_C_2d(i, j)
        end do
    end do

    deallocate(local_A_2d, B_2d, local_C_2d)
end subroutine matrix_multiply_double
</code></pre><p>使用MSYS2的ucrt64工具编译，在Windows下执行Release程序，效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span>        
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">797250s</span><span class="p">(</span><span class="mf">172</span><span class="p">.</span><span class="n">391Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">551850s</span><span class="p">(</span><span class="mf">249</span><span class="p">.</span><span class="n">051Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">560781s</span><span class="p">(</span><span class="mf">245</span><span class="p">.</span><span class="n">085Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">555596s</span><span class="p">(</span><span class="mf">247</span><span class="p">.</span><span class="n">372Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">564455s</span><span class="p">(</span><span class="mf">243</span><span class="p">.</span><span class="n">490Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">552102s</span><span class="p">(</span><span class="mf">248</span><span class="p">.</span><span class="n">938Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">588235s</span><span class="p">(</span><span class="mf">233</span><span class="p">.</span><span class="n">646Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Verification</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mf">7</span><span class="err">:</span> <span class="n">expected</span> <span class="mf">1032.420410</span><span class="p">,</span> <span class="n">got</span> <span class="mf">1032.418823</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">582861s</span><span class="p">(</span><span class="mf">235</span><span class="p">.</span><span class="n">801Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">604666s</span><span class="p">(</span><span class="mf">227</span><span class="p">.</span><span class="n">297Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">615205s</span><span class="p">(</span><span class="mf">223</span><span class="p">.</span><span class="n">404Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">232.647</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">249.051</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">597300s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">551850s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">fortran</span><span class="p">\</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">20</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">fortran</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">matmul-mpi</span><span class="n">-fortran_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">493319s</span><span class="p">(</span><span class="mf">92</span><span class="p">.</span><span class="n">036Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">031578s</span><span class="p">(</span><span class="mf">133</span><span class="p">.</span><span class="n">232Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">074232s</span><span class="p">(</span><span class="mf">127</span><span class="p">.</span><span class="n">942Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">051967s</span><span class="p">(</span><span class="mf">130</span><span class="p">.</span><span class="n">649Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">135295s</span><span class="p">(</span><span class="mf">121</span><span class="p">.</span><span class="n">060Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">071376s</span><span class="p">(</span><span class="mf">128</span><span class="p">.</span><span class="n">283Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">059316s</span><span class="p">(</span><span class="mf">129</span><span class="p">.</span><span class="n">743Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">061684s</span><span class="p">(</span><span class="mf">129</span><span class="p">.</span><span class="n">454Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">042263s</span><span class="p">(</span><span class="mf">131</span><span class="p">.</span><span class="n">866Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">054022s</span><span class="p">(</span><span class="mf">130</span><span class="p">.</span><span class="n">395Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">125.466</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">133.232</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">107505s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">1</span><span class="p">.</span><span class="n">031578s</span>
</span></span></code></pre></div><p>相比前面的矩阵分块算法有很大的提升。注意到单精度浮点数运算时出现一个校验错误，主程序中单精度浮点数校验误差是0.001，这里数值误差增加到了0.0016，超过了前面设定的误差值。在矩阵规模增大时浮点数运算的误差会累积增加，比较合理的解决办法是采用更高精度的浮点数运算或者加大校验误差，前者意味着计算量增加性能下降时间变长，后者则可能导致计算结果可信度降低，究竟该接受哪种代价需要区分计算场合来决定。</p>
<h3 id="32-blas加速">3.2 BLAS加速</h3>
<p>之前演示的blas库底层都通过openmp实现并行加速，但设计上openmp库只适合单节点多核心加速，不适合超算上的多节点多核心的运行环境。有没有一种办法底层可以利用blas库搭配mpi实现跨节点多核心加速呢？下面演示一下实现方法。</p>
<p>首先主程序文件<code>main.c</code>和前面一样直接复用，改动<code>mpi.c</code>增加调用openblas函数实现矩阵运算功能。由于openblas默认使用openmp加速，需要手动设置openblas为单线程运行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cblas.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;openblas_config.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_float</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">float</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置 OpenBLAS 使用单线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">openblas_set_num_threads</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 使用 OpenBLAS 进行局部矩阵乘法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// C = α * A * B + β * C，这里 α = 1.0，β = 1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">cblas_sgemm</span><span class="p">(</span><span class="n">CblasRowMajor</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">rows_per_process</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_C</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">matrix_multiply_double</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">double</span> <span class="n">local_A</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">B</span><span class="p">[],</span> <span class="kt">double</span> <span class="n">local_C</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置 OpenBLAS 使用单线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">openblas_set_num_threads</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 计算每个进程处理的行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rows_per_process</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rows_per_process</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 使用 OpenBLAS 进行局部矩阵乘法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// C = α * A * B + β * C，这里 α = 1.0，β = 1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">cblas_dgemm</span><span class="p">(</span><span class="n">CblasRowMajor</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span> <span class="n">CblasNoTrans</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">rows_per_process</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_A</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="mf">1.0</span><span class="p">,</span> <span class="n">local_C</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>CMakeLists.txt</code>中还需要链接到openblas和openmp，否则无法通过编译。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.13</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">openblas-mpi</span> <span class="s">LANGUAGES</span> <span class="s">C</span> <span class="s">CXX</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">20</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">EXECUTE_FILE_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_FRONTEND_VARIANT</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_ID</span><span class="o">}</span><span class="s">_</span><span class="o">${</span><span class="nv">CMAKE_C_COMPILER_VERSION</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">string</span><span class="p">(</span><span class="s">TOLOWER</span> <span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">EXECUTE_FILE_NAME</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Enable MPI support
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Find OpenBLAS
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenMP</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenBLAS</span> <span class="s">CONFIG</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SRC_LIST</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/main.c</span>
</span></span><span class="line"><span class="cl">    <span class="s">src/mpi.c</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SRC_LIST</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_CXX_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTE_FILE_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenBLAS::OpenBLAS</span>
</span></span><span class="line"><span class="cl">    <span class="s">OpenMP::OpenMP_C</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MPI_LIBRARIES</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">
</span></span></span></code></pre></div><p>在Windows下编译，使用MSYS2的ucrt64工具链和其自带的openblas，编译输出Release程序，运行效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="nb">openblas-mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="nb">openblas-mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">openblas-mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">float</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">162794s</span><span class="p">(</span><span class="mf">844</span><span class="p">.</span><span class="n">252Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">178354s</span><span class="p">(</span><span class="mf">770</span><span class="p">.</span><span class="n">595Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">201812s</span><span class="p">(</span><span class="mf">681</span><span class="p">.</span><span class="n">023Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">191400s</span><span class="p">(</span><span class="mf">718</span><span class="p">.</span><span class="n">073Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">186770s</span><span class="p">(</span><span class="mf">735</span><span class="p">.</span><span class="n">872Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">200100s</span><span class="p">(</span><span class="mf">686</span><span class="p">.</span><span class="n">850Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">182761s</span><span class="p">(</span><span class="mf">752</span><span class="p">.</span><span class="n">013Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">181107s</span><span class="p">(</span><span class="mf">758</span><span class="p">.</span><span class="n">882Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">182459s</span><span class="p">(</span><span class="mf">753</span><span class="p">.</span><span class="n">258Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">190692s</span><span class="p">(</span><span class="mf">720</span><span class="p">.</span><span class="n">739Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">742.156</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">844.252</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">185825s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">162794s</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">D:</span><span class="p">\</span><span class="n">example</span><span class="p">\</span><span class="n">efficiency_v3</span><span class="p">\</span><span class="n">c</span><span class="p">\</span><span class="nb">openblas-mpi</span><span class="p">\</span><span class="n">build</span><span class="p">&gt;</span> <span class="n">mpiexec</span> <span class="n">-n</span> <span class="mf">10</span> <span class="n">D:</span><span class="p">/</span><span class="n">example</span><span class="p">/</span><span class="n">efficiency_v3</span><span class="p">/</span><span class="n">c</span><span class="p">/</span><span class="nb">openblas-mpi</span><span class="p">/</span><span class="n">build</span><span class="p">/</span><span class="nb">openblas-mpi_gnu_gnu_15</span><span class="p">.</span><span class="py">1</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="py">exe</span> <span class="n">-l</span> <span class="mf">10</span> <span class="n">-n</span> <span class="mf">12</span> <span class="n">-double</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">double</span> <span class="n">precision</span> <span class="k">for</span> <span class="n">matrix</span> <span class="n">multiplication</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="mf">1</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">267384s</span><span class="p">(</span><span class="mf">514</span><span class="p">.</span><span class="n">013Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">2</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">361675s</span><span class="p">(</span><span class="mf">380</span><span class="p">.</span><span class="n">007Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">3</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">338016s</span><span class="p">(</span><span class="mf">406</span><span class="p">.</span><span class="n">605Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">331837s</span><span class="p">(</span><span class="mf">414</span><span class="p">.</span><span class="n">176Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">5</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">352789s</span><span class="p">(</span><span class="mf">389</span><span class="p">.</span><span class="n">578Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">346735s</span><span class="p">(</span><span class="mf">396</span><span class="p">.</span><span class="n">381Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">7</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">343613s</span><span class="p">(</span><span class="mf">399</span><span class="p">.</span><span class="n">982Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">8</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">349749s</span><span class="p">(</span><span class="mf">392</span><span class="p">.</span><span class="n">965Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">9</span>       <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">340508s</span><span class="p">(</span><span class="mf">403</span><span class="p">.</span><span class="n">629Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">10</span>      <span class="err">:</span> <span class="mf">4096</span> <span class="n">x</span> <span class="mf">4096</span> <span class="n">Matrix</span> <span class="n">multiply</span> <span class="n">wall</span> <span class="n">time</span> <span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">347642s</span><span class="p">(</span><span class="mf">395</span><span class="p">.</span><span class="n">347Gflops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">409.268</span><span class="p">,</span> <span class="n">Max</span> <span class="n">Gflops</span><span class="err">:</span> <span class="mf">514.013</span>
</span></span><span class="line"><span class="cl"><span class="n">Average</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">337995s</span><span class="p">,</span> <span class="n">Min</span> <span class="n">Time</span><span class="err">:</span> <span class="mf">0</span><span class="p">.</span><span class="n">267384s</span>
</span></span></code></pre></div><p>可以看到计算速度相比于前面的方法已经有了很大的提升。这里没有用到超线程，但是这个结果已经和单独使用openblas加速运算的效果十分接近了，双精度浮点运算性能甚至要更好一些。测试过程中使用超线程没能达成更好的效果，而且有很大几率会导致程序崩溃，可能是openmp和mpi混用所导致的。</p>
<h2 id="4-总结">4. 总结</h2>
<p>在单机上运行，编写mpi程序需要单独控制内存和消息广播，编码和调试更加麻烦，而且会带来额外的性能开销，跟openmp相比没有性能上的优势，反而openmp编码上更有优势。</p>
<p>mpi存在的意义在于超算集群等机器上的跨节点多核调用，使用mpi开发的高性能计算程序尤其适合在这种场合下通过大集群多节点的调用进行加速。</p>
<p>对高性能计算程序而言，单独使用mpi对循环加速其实没有多大意义，应配合编译器和专业数学库的优化实现计算加速。</p>
<hr>

      </article>

      


  
<script type="text/javascript">
  (function() {
    const themeToggle = document.querySelector('.darkmode-toggle input');
    const light = 'light';
    const dark = 'dark';
    let isDark = localStorage.theme === dark || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
    let theme = isDark ? dark : light;

    const s = document.createElement('script');
    s.type = 'text/javascript';
    const dataset = {
        repo: 'AndrewMoa2005\/AndrewMoa2005.github.io',
        repoId: 'R_kgDOOSI4_A',
        category: 'General',
        categoryId: 'DIC_kwDOOSI4_M4Co1Kf',
        mapping: 'pathname',
        reactionsEnabled: '1',
        emitMetadata: '0',
        theme: theme,
        lang: 'en',
    };
    s.src = 'https://giscus.app/client.js';
    s.crossorigin = 'anonymous';
    s.async = true;
    Object.entries(dataset).forEach(function(a) {
        return s.dataset[a[0]] = a[1];
    });

    const curScriptElement = document.currentScript;
    curScriptElement.parentNode.insertBefore(s, curScriptElement);

    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }

    themeToggle.addEventListener('change', function () {
      if (this.checked) {
        theme = dark;
      } else {
        theme = light;
      }
      sendMessage({
        setConfig: {
          theme: theme,
        }
      });
    });
  })();
</script>
  



    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
  
  
  
  
  
  
  
  
    <a href="https://github.com/AndrewMoa2005" target="_blank" title="Github" class="flex flex-row mr-2">
      <span class="hidden">Github</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
 </i>
    </a>
  
  
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2025 Andrew Moa
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/main.min.65ca5b0808abf278fcec5d424701ebf0b4bc46a737129cd5e57fdb739f463e79.js"></script>

<div class="hidden top-1 right-1" id="code-copy">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
</svg>

  </i>
</div>
<div class="hidden top-1 right-1" id="code-copy-done">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M5 12l5 5l10 -10" />
</svg>

  </i>
</div><script src="/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js"></script>





</body>
</html>
